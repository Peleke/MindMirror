name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: mindmirror-prod  # Production GCP project
  GCP_REGION: us-east4
  ARTIFACT_REGISTRY: us-east4-docker.pkg.dev
  ARTIFACT_REPO: mindmirror

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Detect which services changed
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
      version_tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version tag
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          SHA=$(git rev-parse --short HEAD)
          TAG="v${VERSION}-${SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version tag: $TAG"

      - name: Detect changed services
        id: detect
        run: |
          chmod +x scripts/changed-services.sh
          SERVICES=$(scripts/changed-services.sh origin/main^)
          echo "services=$SERVICES" >> $GITHUB_OUTPUT

          if [ "$SERVICES" = "[]" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No service changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changed services: $SERVICES"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Build and push Docker images to PRODUCTION registry
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build-and-push:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.services) }}
        exclude:
          # Skip frontend apps (manual deploy for now)
          - service: web_app
          - service: mobile_app
          # Skip deprecated celery worker
          - service: celery_worker
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Production)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PRODUCTION_PROJECT_NUM }}/locations/global/workloadIdentityPools/github-pool/providers/github-oidc'
          service_account: 'github-actions-production@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }} --quiet

      - name: Build and push image
        env:
          VERSION_TAG: ${{ needs.detect-changes.outputs.version_tag }}
        run: |
          SERVICE="${{ matrix.service }}"

          # Map service to Dockerfile and image name
          case "$SERVICE" in
            agent_service)
              DOCKERFILE="src/agent_service/Dockerfile"
              IMAGE_NAME="agent_service"
              ;;
            journal_service)
              DOCKERFILE="journal_service/Dockerfile"
              IMAGE_NAME="journal_service"
              ;;
            habits_service)
              DOCKERFILE="habits_service/Dockerfile"
              IMAGE_NAME="habits_service"
              ;;
            meals_service)
              DOCKERFILE="meals_service/Dockerfile"
              IMAGE_NAME="meals_service"
              ;;
            movements_service)
              DOCKERFILE="movements_service/Dockerfile"
              IMAGE_NAME="movements_service"
              ;;
            practices_service)
              DOCKERFILE="practices_service/Dockerfile"
              IMAGE_NAME="practices_service"
              ;;
            users_service)
              DOCKERFILE="users_service/Dockerfile"
              IMAGE_NAME="users_service"
              ;;
            celery_worker)
              DOCKERFILE="celery-worker/Dockerfile"
              IMAGE_NAME="celery-worker"
              ;;
            mesh_gateway)
              DOCKERFILE="mesh/Dockerfile"
              IMAGE_NAME="mesh"
              BUILD_CONTEXT="mesh"
              ;;
            *)
              echo "âŒ Unknown service: $SERVICE"
              exit 1
              ;;
          esac

          IMAGE="${{ env.ARTIFACT_REGISTRY }}/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${IMAGE_NAME}:${VERSION_TAG}"

          # Use service-specific build context if defined, otherwise use repo root
          BUILD_CONTEXT="${BUILD_CONTEXT:-.}"

          echo "ğŸ—ï¸  Building $IMAGE"
          docker build -t "$IMAGE" -f "$DOCKERFILE" "$BUILD_CONTEXT"

          echo "ğŸ“¤ Pushing $IMAGE"
          docker push "$IMAGE"

          echo "âœ… Pushed $IMAGE"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Generate tfvars and create PR (requires approval)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  create-deploy-pr:
    needs: [detect-changes, build-and-push]
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push deployment branch and create PR
      pull-requests: write  # Required to create pull request
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate production.auto.tfvars
        env:
          VERSION_TAG: ${{ needs.detect-changes.outputs.version_tag }}
        run: |
          chmod +x scripts/generate-tfvars.sh
          ./scripts/generate-tfvars.sh production "$VERSION_TAG" > infra/production.auto.tfvars
          echo "ğŸ“ Generated infra/production.auto.tfvars"

      - name: Create deployment branch
        env:
          VERSION_TAG: ${{ needs.detect-changes.outputs.version_tag }}
        run: |
          BRANCH_NAME="deploy-production-${VERSION_TAG}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add infra/production.auto.tfvars
          git commit -m "chore(production): update tfvars to ${VERSION_TAG}"
          git push origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: deploy-production-${{ needs.detect-changes.outputs.version_tag }}
          base: main
          title: "ğŸš€ Deploy to Production: ${{ needs.detect-changes.outputs.version_tag }}"
          body: |
            ## Production Deployment

            **Version**: `${{ needs.detect-changes.outputs.version_tag }}`
            **Services**: ${{ needs.detect-changes.outputs.services }}

            ### What's Changing
            - Updated `infra/production.auto.tfvars` with new image tags
            - All changed services will be deployed to production

            ### Deployment Process
            1. âœ… Images built and pushed to production registry
            2. â³ Terrateam will post plan below automatically
            3. ğŸ‘€ **Review the plan carefully**
            4. âœ… If plan looks good, comment: `terrateam apply`
            5. ğŸš€ Terrateam will apply changes to production
            6. âœ… Merge this PR after successful deployment

            ### Pre-Deployment Checklist
            - [ ] Reviewed Terrateam plan for unexpected changes
            - [ ] Verified image tags are correct
            - [ ] Confirmed no breaking changes in deployment
            - [ ] Ready to approve deployment

            ---
            **Note**: This PR was auto-generated by GitHub Actions.
            Terrateam will automatically plan the deployment and post results here.
          labels: |
            production
            deployment
            automated

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Summary
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  summary:
    needs: [detect-changes, create-deploy-pr]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Production Deployment PR Created"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Version: ${{ needs.detect-changes.outputs.version_tag }}"
          echo "Services: ${{ needs.detect-changes.outputs.services }}"
          echo ""
          echo "âœ… Images built and pushed to production registry"
          echo "âœ… production.auto.tfvars updated"
          echo "âœ… Pull request created for deployment"
          echo ""
          echo "ğŸ“‹ Next Steps:"
          echo "   1. Review PR at: https://github.com/${{ github.repository }}/pulls"
          echo "   2. Wait for Terrateam plan (1-2 minutes)"
          echo "   3. Review plan carefully"
          echo "   4. Comment 'terrateam apply' to deploy"
          echo "   5. Merge PR after successful deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
