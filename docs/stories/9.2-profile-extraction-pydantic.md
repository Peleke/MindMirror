# Story 9.2: Profile Extraction with PydanticAI

## Status
Draft

## Story
**As a** developer
**I want** structured profile data extracted from conversation
**so that** we can store profiles in database and personalize UI

## Acceptance Criteria

1. PydanticAI `result_type=UserProfile` extracts structured data: name, eating_profile, movement_profile
2. Validation: Weight 50-500 lbs/20-200 kg, Height 4'0"-7'0"/120-220 cm, Eating preference from predefined list, At least one training preference, At least one goal
3. If extraction fails (invalid data), agent asks clarifying question
4. Successful extraction → POST to users_service GraphQL API (`createUserProfile`)
5. Extraction accuracy >90% (validated via spot-checks)

## Tasks / Subtasks

- [ ] Define Pydantic models (AC: 1, 2)
  - [ ] Create `UserProfile` model with name, eating_profile, movement_profile
  - [ ] Create `EatingProfile` model with weight, weight_unit, height, height_unit, eating_preference
  - [ ] Create `MovementProfile` model with training_preferences, goals
  - [ ] Add Pydantic validators for ranges (weight, height)

- [ ] Configure PydanticAI agent (AC: 1)
  - [ ] Initialize agent with `result_type=UserProfile`
  - [ ] Set system prompt: "Extract structured profile data from conversation"
  - [ ] Use OpenAI GPT-4o-mini (cost-effective)

- [ ] Implement extraction trigger (AC: 3, 4)
  - [ ] After user confirms data in confirmation screen, trigger extraction
  - [ ] Call `agent.run()` with full conversation history
  - [ ] Handle validation errors (Pydantic ValidationError)
  - [ ] If validation fails → ask clarifying question
  - [ ] If validation succeeds → POST to users_service

- [ ] Integrate with users_service API (AC: 4)
  - [ ] Call GraphQL mutation: `createUserProfile(input: $input)`
  - [ ] Handle API errors (network failure, server error)
  - [ ] Retry logic: 3 retries with exponential backoff
  - [ ] On success → send completion message to mobile

- [ ] Add accuracy monitoring (AC: 5)
  - [ ] Log extracted profiles to Logfire with conversation ID
  - [ ] Manual spot-check script: Compare extracted data vs. conversation transcript
  - [ ] Target: >90% accuracy (weight, height, preferences match user input)

## Dev Notes

### Relevant Source Tree
- **Location:** `onboarding-agent/models.py` (Pydantic models)
- **Location:** `onboarding-agent/extraction.py` (PydanticAI logic)

### Key Technical Details
- PydanticAI structured extraction: https://ai.pydantic.dev/structured-outputs/
- OpenAI GPT-4o-mini: $0.15/1M input tokens, $0.60/1M output tokens
- Pydantic validators ensure data integrity before database storage

### Implementation Notes
```python
# Pydantic models
from pydantic import BaseModel, validator
from typing import List, Literal

class EatingProfile(BaseModel):
    weight: float
    weight_unit: Literal["lbs", "kg"]
    height: float
    height_unit: Literal["ft_in", "cm"]
    eating_preference: Literal["omnivore", "vegetarian", "vegan", "pescatarian", "other"]

    @validator("weight")
    def validate_weight(cls, v, values):
        unit = values.get("weight_unit")
        if unit == "lbs" and not (50 <= v <= 500):
            raise ValueError("Weight must be between 50-500 lbs")
        if unit == "kg" and not (20 <= v <= 200):
            raise ValueError("Weight must be between 20-200 kg")
        return v

class MovementProfile(BaseModel):
    training_preferences: List[str]
    goals: List[str]

    @validator("training_preferences")
    def validate_training_prefs(cls, v):
        if len(v) == 0:
            raise ValueError("At least one training preference required")
        return v

class UserProfile(BaseModel):
    name: str
    eating_profile: EatingProfile
    movement_profile: MovementProfile

# PydanticAI agent
from pydantic_ai import Agent

agent = Agent(
    'openai:gpt-4o-mini',
    result_type=UserProfile,
    system_prompt="""You are extracting structured profile data from a fitness onboarding conversation.
    Extract the user's name, eating profile (weight, height, preferences), and movement profile (training preferences, goals).
    Be precise with numeric values. If uncertain, return null for that field."""
)

# Extraction
async def extract_profile(conversation_history: list) -> UserProfile:
    result = await agent.run(conversation_history)
    return result.data  # UserProfile instance
```

### Testing
**Test file location:** `onboarding-agent/tests/test_extraction.py`

**Test standards:**
- Unit tests for Pydantic validators
- Integration test: Mock conversation → extract profile
- Accuracy test: 20 real conversations, spot-check extraction

**Testing frameworks:**
- pytest
- pytest-asyncio for async tests
- Mock OpenAI API responses

**Specific testing requirements:**
- Test valid profile extraction (all fields populated)
- Test validation errors (weight=1000 lbs → raises ValueError)
- Test partial profile (eating only, movement missing → null)
- Test OpenAI API failure → graceful error handling
- Spot-check 20 conversations for >90% accuracy

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 9 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
