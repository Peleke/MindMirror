# Story 3.7: Infrastructure Bootstrapping Automation

## Status
Draft

## Story
**As a** platform engineer
**I want** `make production-deploy` command with synced runbook documentation
**So that** manual deployment is streamlined and repeatable for 48hr launch window

## Acceptance Criteria

1. **`make production-deploy` command exists:** Single command deploys entire production infrastructure (OpenTofu + Supabase + validation)
2. **Prerequisite validation:** Script checks for required tools (gcloud, tofu, supabase CLI) and authentication before proceeding
3. **Idempotent execution:** Running command twice doesn't break existing resources (safe to re-run)
4. **Progress output:** Command shows clear progress indicators (which step is running, success/failure status)
5. **Error handling:** Script fails fast on errors with actionable error messages
6. **Runbook documentation:** `docs/infrastructure/production-deployment-runbook.md` documents every step, kept in sync with Makefile
7. **Backup automation:** OpenTofu state automatically backed up before deployment
8. **Post-deployment validation:** Script validates critical services are healthy after deployment

## Tasks / Subtasks

- [ ] **Create `make production-deploy` target** (AC: 1, 2, 3, 4, 5, 7, 8)
  - [ ] Add target to root `Makefile`:
    ```makefile
    .PHONY: production-deploy
    production-deploy:
    	@echo "=== MindMirror Production Deployment ==="
    	@echo "Starting deployment at $(shell date)"
    	@./scripts/production-deploy.sh
    ```
  - [ ] Create `scripts/production-deploy.sh` (main deployment script)
  - [ ] Make script executable: `chmod +x scripts/production-deploy.sh`

- [ ] **Implement prerequisite validation** (AC: 2)
  - [ ] Check required tools installed:
    ```bash
    #!/bin/bash
    set -e  # Exit on error

    echo "Checking prerequisites..."

    # Check gcloud CLI
    if ! command -v gcloud &> /dev/null; then
      echo "ERROR: gcloud CLI not found. Install: https://cloud.google.com/sdk/docs/install"
      exit 1
    fi

    # Check OpenTofu
    if ! command -v tofu &> /dev/null; then
      echo "ERROR: OpenTofu not found. Install: https://opentofu.org/docs/intro/install/"
      exit 1
    fi

    # Check Supabase CLI
    if ! command -v supabase &> /dev/null; then
      echo "ERROR: Supabase CLI not found. Install: npm install -g supabase"
      exit 1
    fi

    echo "✓ All required tools installed"
    ```
  - [ ] Check authentication:
    ```bash
    # Check gcloud auth
    if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" | grep -q "."; then
      echo "ERROR: Not authenticated with gcloud. Run: gcloud auth login"
      exit 1
    fi

    echo "✓ Authenticated with gcloud as: $(gcloud auth list --filter=status:ACTIVE --format='value(account)')"
    ```

- [ ] **Implement OpenTofu deployment** (AC: 3, 4, 7)
  - [ ] Backup OpenTofu state:
    ```bash
    echo "Backing up OpenTofu state..."
    cd infra
    tofu state pull > ../backups/terraform-state-$(date +%Y%m%d-%H%M%S).json
    echo "✓ State backed up to backups/terraform-state-$(date +%Y%m%d-%H%M%S).json"
    ```
  - [ ] Run OpenTofu init and plan:
    ```bash
    echo "Initializing OpenTofu..."
    tofu init -upgrade

    echo "Planning infrastructure changes..."
    tofu plan -var-file=../env.production -out=production.tfplan

    echo "OpenTofu plan created. Review above output."
    read -p "Proceed with deployment? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
      echo "Deployment cancelled."
      exit 0
    fi
    ```
  - [ ] Apply OpenTofu plan:
    ```bash
    echo "Applying infrastructure changes..."
    tofu apply production.tfplan

    echo "✓ Infrastructure deployed successfully"
    ```

- [ ] **Implement Supabase setup** (AC: 3, 4)
  - [ ] Run Supabase migrations:
    ```bash
    echo "Applying Supabase migrations..."

    # Export production database URL
    export DATABASE_URL=$(gcloud secrets versions access latest --secret=production-database-url)

    # Run Alembic migrations
    cd ../src/alembic-config
    alembic upgrade head

    # Run service-specific migrations
    cd ../../habits_service/alembic && alembic upgrade head
    cd ../../movements_service/alembic && alembic upgrade head
    cd ../../practices_service/alembic && alembic upgrade head
    cd ../../users_service/alembic && alembic upgrade head

    echo "✓ Database migrations completed"
    ```
  - [ ] Apply RLS policies (if not in migrations):
    ```bash
    echo "Applying RLS policies..."
    psql "$DATABASE_URL" < ../scripts/supabase-rls-policies.sql
    echo "✓ RLS policies applied"
    ```

- [ ] **Implement post-deployment validation** (AC: 8)
  - [ ] Health check all services:
    ```bash
    echo "Validating deployments..."

    SERVICES=(
      "https://gateway-prod-xyz.a.run.app/healthcheck"
      "https://agent-service-prod-xyz.a.run.app/health"
      "https://journal-service-prod-xyz.a.run.app/health"
      "https://users-service-prod-xyz.a.run.app/health"
      # ... (add all services)
    )

    for url in "${SERVICES[@]}"; do
      echo -n "Checking $url..."
      if curl -s -o /dev/null -w "%{http_code}" "$url" | grep -q "200"; then
        echo " ✓"
      else
        echo " ✗ FAILED"
        exit 1
      fi
    done

    echo "✓ All services healthy"
    ```
  - [ ] Test end-to-end workflow (optional):
    ```bash
    echo "Running end-to-end test..."
    # TODO: Add GraphQL query test or skip for now
    echo "✓ End-to-end test passed (manual validation required)"
    ```

- [ ] **Implement error handling** (AC: 5)
  - [ ] Use `set -e` to exit on error
  - [ ] Add trap for cleanup on failure:
    ```bash
    trap 'echo "ERROR: Deployment failed at line $LINENO"; exit 1' ERR
    ```
  - [ ] Provide actionable error messages:
    ```bash
    if ! tofu plan ...; then
      echo "ERROR: OpenTofu plan failed. Check the output above for details."
      echo "Common issues:"
      echo "  - Missing environment variables in env.production"
      echo "  - Invalid resource configuration"
      echo "  - State file corruption (restore from backup)"
      exit 1
    fi
    ```

- [ ] **Write runbook documentation** (AC: 6)
  - [ ] Create `docs/infrastructure/production-deployment-runbook.md`
  - [ ] Document prerequisites (tools, authentication, secrets)
  - [ ] Document step-by-step manual deployment process (mirrors Makefile)
  - [ ] Document troubleshooting (common errors, how to fix)
  - [ ] Document rollback procedures (restore OpenTofu state, revert migrations)
  - [ ] Keep runbook in sync with `scripts/production-deploy.sh`

- [ ] **Test idempotency** (AC: 3)
  - [ ] Run `make production-deploy` in staging
  - [ ] Run again immediately (should be no-op or minimal changes)
  - [ ] Verify no errors, no resource recreation

## Dev Notes

### Relevant Source Tree
- **Makefile:** Root `Makefile` (add `production-deploy` target)
- **Scripts:** `scripts/production-deploy.sh` (main deployment script)
- **OpenTofu:** `infra/` (infrastructure code)
- **Migrations:** `src/alembic-config/`, service-specific alembic directories
- **Documentation:** `docs/infrastructure/production-deployment-runbook.md` (to be created)
- **Backups:** `backups/` (OpenTofu state backups)

### Key Technical Details

**Makefile vs. Shell Script:**
- **Makefile:** Thin wrapper for discoverability (`make production-deploy`)
- **Shell Script:** All logic in `scripts/production-deploy.sh` (easier to test/debug)

**Idempotency:**
- **OpenTofu:** Naturally idempotent (plan shows "no changes" if already deployed)
- **Migrations:** Alembic tracks applied migrations (won't re-run)
- **RLS Policies:** Use `CREATE POLICY IF NOT EXISTS` for idempotency

**State Backup:**
- Backup before every deployment (prevents catastrophic state loss)
- Store backups in `backups/` directory (gitignored)
- Consider uploading backups to GCS for durability

**Manual Confirmation:**
- Ask user to confirm after OpenTofu plan (safety check)
- User reviews plan output before proceeding
- Can skip confirmation with env var: `AUTO_APPROVE=true make production-deploy`

### Implementation Notes

**Script Best Practices:**
- Use `set -e` (exit on error)
- Use `set -u` (error on undefined variables)
- Use `set -o pipefail` (pipe failures propagate)
- Add progress indicators (`echo "Step X/Y: ..."`)
- Add timestamps (`echo "$(date): Starting deployment"`)

**Deployment Order:**
1. Prerequisites validation
2. OpenTofu state backup
3. OpenTofu init + plan
4. User confirmation
5. OpenTofu apply
6. Supabase migrations
7. RLS policies
8. Health checks

**Rollback Procedure (if deployment fails):**
1. Restore OpenTofu state: `cd infra && tofu state push ../backups/terraform-state-[timestamp].json`
2. Run `tofu apply` to revert to previous state
3. Rollback database migrations: `alembic downgrade -1` (or specific revision)

### Testing

**Test file location:** Staging environment (test deployment script before production)

**Test standards:**
- Script runs without errors
- All prerequisites validated correctly
- OpenTofu plan/apply succeed
- Migrations applied successfully
- Health checks pass
- Idempotent (running twice is safe)

**Testing frameworks:**
- Manual testing in staging environment
- Shell script validation (shellcheck)

**Specific testing requirements:**

1. **Prerequisites Validation Test:**
   ```bash
   # Test with missing tool (e.g., uninstall supabase CLI temporarily)
   make production-deploy
   # Expected: Error message about missing supabase CLI

   # Test without gcloud auth
   gcloud auth revoke
   make production-deploy
   # Expected: Error message about missing authentication
   ```

2. **Idempotency Test:**
   ```bash
   # Deploy to staging
   make staging-deploy  # (create this target for staging)

   # Deploy again immediately
   make staging-deploy

   # Expected: OpenTofu shows "No changes", migrations show "no new migrations"
   ```

3. **Rollback Test:**
   ```bash
   # Make intentional breaking change in OpenTofu
   # Run deployment (will fail)
   # Restore state from backup:
   cd infra && tofu state push ../backups/terraform-state-[latest].json

   # Run tofu apply to revert
   tofu apply -var-file=../env.staging

   # Verify services are back to previous state
   ```

4. **Health Check Test:**
   ```bash
   # Deploy infrastructure
   make production-deploy

   # Script should automatically check health endpoints
   # Verify output shows ✓ for all services

   # Manually verify one service:
   curl https://gateway-prod-xyz.a.run.app/healthcheck
   # Expected: 200 OK
   ```

## Runbook Documentation Outline

The `docs/infrastructure/production-deployment-runbook.md` should include:

1. **Prerequisites**
   - Required tools (gcloud, OpenTofu, Supabase CLI)
   - Authentication setup
   - Environment variables
   - Secrets created in Secret Manager

2. **Deployment Steps** (mirrors script)
   - Step 1: Prerequisites validation
   - Step 2: Backup OpenTofu state
   - Step 3: OpenTofu init/plan/apply
   - Step 4: Supabase migrations
   - Step 5: RLS policies
   - Step 6: Health checks

3. **Troubleshooting**
   - OpenTofu plan fails → Check env.production variables
   - Migrations fail → Check database connectivity
   - Health checks fail → Check Cloud Run logs
   - State corruption → Restore from backup

4. **Rollback Procedures**
   - OpenTofu state restore
   - Database migration rollback
   - Secrets rollback

5. **Emergency Procedures**
   - How to manually access secrets
   - How to restart services
   - How to disable RLS (emergency only)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | v1.0 | New story: Infrastructure bootstrapping with `make production-deploy` and comprehensive runbook | Alex (DevOps Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
