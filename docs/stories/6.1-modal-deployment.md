# Story 6.1: Modal Deployment Setup

## Status
Draft

## Story
**As a** platform engineer
**I want** PydanticAI + FastAPI agent deployed on Modal
**so that** the agent auto-scales and requires no infrastructure management

## Acceptance Criteria

1. Modal project created with `modal setup`
2. FastAPI app defined with `@app.function()` decorator
3. WebSocket endpoint: `wss://[modal-url]/chat/{user_id}`
4. REST endpoint: `POST /extract-profile` (for batch processing)
5. Environment variables: `OPENAI_API_KEY`, `LOGFIRE_TOKEN`, `REDIS_URL`
6. `modal deploy` completes successfully, returns public URL
7. Health check endpoint: `GET /health` returns 200

## Tasks / Subtasks

- [ ] Set up Modal account and CLI (AC: 1)
  - [ ] Install Modal CLI: `pip install modal`
  - [ ] Authenticate: `modal setup`
  - [ ] Create new Modal app: `modal app create mindmirror-onboarding`

- [ ] Create FastAPI application with Modal decorators (AC: 2, 3, 4)
  - [ ] Define `app.py` with FastAPI instance
  - [ ] Add `@app.function()` decorator for Modal deployment
  - [ ] Implement WebSocket endpoint at `/chat/{user_id}`
  - [ ] Implement REST endpoint at `/extract-profile`
  - [ ] Add health check at `/health`

- [ ] Configure environment variables (AC: 5)
  - [ ] Set secrets in Modal dashboard: `OPENAI_API_KEY`, `LOGFIRE_TOKEN`, `REDIS_URL`
  - [ ] Use `@app.function(secrets=[modal.Secret.from_name("openai-api-key")])` pattern
  - [ ] Validate secrets loaded correctly in startup event

- [ ] Deploy and validate (AC: 6, 7)
  - [ ] Run `modal deploy app.py`
  - [ ] Capture public URL from deployment output
  - [ ] Test health check: `curl https://[modal-url]/health`
  - [ ] Test WebSocket connection with `wscat` or Postman

## Dev Notes

### Relevant Source Tree
- **Location:** New directory `onboarding-agent/` (separate from existing services)
- **Modal Docs:** https://modal.com/docs/guide/webhooks
- **PydanticAI Docs:** https://ai.pydantic.dev/

### Key Technical Details
- Modal auto-scales based on requests (0-100+ instances)
- WebSocket connections require `@app.function(container_idle_timeout=600)` for long-lived connections
- Use Modal volumes for persistent storage if needed (defer to Redis for now)
- Cold starts typically <1s with Modal

### Implementation Notes
```python
# Example Modal FastAPI structure
import modal
from fastapi import FastAPI, WebSocket

app = modal.App("mindmirror-onboarding")
web_app = FastAPI()

@app.function(
    image=modal.Image.debian_slim().pip_install(
        "fastapi", "pydantic-ai", "websockets"
    ),
    secrets=[modal.Secret.from_name("openai-api-key")],
    container_idle_timeout=600  # Keep WebSocket connections alive
)
@modal.asgi_app()
def fastapi_app():
    return web_app

@web_app.get("/health")
def health():
    return {"status": "healthy"}

@web_app.websocket("/chat/{user_id}")
async def chat_endpoint(websocket: WebSocket, user_id: str):
    await websocket.accept()
    # Conversation logic here
```

### Testing
**Test file location:** `onboarding-agent/tests/test_deployment.py`

**Test standards:**
- Integration test: Deploy to Modal staging, validate endpoints respond
- Load test: Simulate 10 concurrent WebSocket connections
- Health check test: Validate `/health` returns 200

**Testing frameworks:**
- pytest for unit tests
- `websockets` library for WebSocket testing
- Modal CLI for deployment testing

**Specific testing requirements:**
- Validate WebSocket accepts connections
- Test health check endpoint
- Confirm environment variables loaded correctly
- Measure cold start time (<2s acceptable)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 6 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
