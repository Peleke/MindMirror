# Story 10.3: Incomplete Profile Notifications

## Status
Draft

## Story
**As a** user
**I want** a reminder notification if I skip onboarding
**so that** I'm encouraged to complete my profile later

## Acceptance Criteria

1. When user skips onboarding (`onboarding_status: skipped`), schedule push notification for 24 hours later
2. Notification title: "Finish your MindMirror profile"
3. Notification body: "Complete setup to get personalized recommendations"
4. Tapping notification opens app to `/onboarding/chat`
5. Notification only sent once (not daily spam)
6. User can disable in settings: "Profile setup reminders" toggle (default: enabled)

## Tasks / Subtasks

- [ ] Schedule notification on skip (AC: 1)
  - [ ] In onboarding launch screen, when user taps "Skip"
  - [ ] Call `scheduleProfileReminderNotification()` function
  - [ ] Schedule for 24 hours from now (86400 seconds)

- [ ] Configure notification content (AC: 2, 3, 4)
  - [ ] Title: "Finish your MindMirror profile"
  - [ ] Body: "Complete setup to get personalized recommendations"
  - [ ] Data: `{ route: '/(onboarding)/chat' }` (for deep linking)

- [ ] Implement deep linking (AC: 4)
  - [ ] Add notification response listener
  - [ ] Extract `route` from notification data
  - [ ] Navigate to route when notification tapped

- [ ] Prevent duplicate notifications (AC: 5)
  - [ ] Check if notification already scheduled before creating new one
  - [ ] Use AsyncStorage to track: `profile_reminder_sent: true`
  - [ ] Only schedule if `profile_reminder_sent === false`

- [ ] Add settings toggle (AC: 6)
  - [ ] Settings page: "Profile setup reminders" toggle
  - [ ] Default: enabled
  - [ ] If disabled, cancel scheduled notifications
  - [ ] Store preference in AsyncStorage

## Dev Notes

### Relevant Source Tree
- **Location:** `mindmirror-mobile/app/(onboarding)/launch.tsx` (schedule notification)
- **Location:** `mindmirror-mobile/app/(app)/settings.tsx` (toggle)
- **Notifications:** Expo Notifications API

### Key Technical Details
- Expo Notifications: `expo-notifications` package
- AsyncStorage for tracking sent notifications
- Deep linking via Expo Router

### Implementation Notes
```typescript
// Schedule notification
import * as Notifications from 'expo-notifications';
import AsyncStorage from '@react-native-async-storage/async-storage';

export const scheduleProfileReminderNotification = async () => {
  // Check if already sent
  const alreadySent = await AsyncStorage.getItem('profile_reminder_sent');
  if (alreadySent === 'true') return;

  // Check if user disabled reminders
  const remindersEnabled = await AsyncStorage.getItem('profile_reminders_enabled');
  if (remindersEnabled === 'false') return;

  await Notifications.scheduleNotificationAsync({
    content: {
      title: "Finish your MindMirror profile",
      body: "Complete setup to get personalized recommendations",
      data: { route: '/(onboarding)/chat' }
    },
    trigger: {
      seconds: 86400, // 24 hours
    },
  });

  // Mark as sent
  await AsyncStorage.setItem('profile_reminder_sent', 'true');
};

// Notification handler (in App.tsx)
import { useEffect } from 'react';
import { router } from 'expo-router';

export default function App() {
  useEffect(() => {
    const subscription = Notifications.addNotificationResponseReceivedListener(response => {
      const route = response.notification.request.content.data.route;
      if (route) {
        router.push(route);
      }
    });

    return () => subscription.remove();
  }, []);

  return <RootLayout />;
}

// Settings toggle
export default function Settings() {
  const [remindersEnabled, setRemindersEnabled] = useState(true);

  useEffect(() => {
    const loadPreference = async () => {
      const enabled = await AsyncStorage.getItem('profile_reminders_enabled');
      setRemindersEnabled(enabled !== 'false');  // Default true
    };
    loadPreference();
  }, []);

  const handleToggle = async (value: boolean) => {
    setRemindersEnabled(value);
    await AsyncStorage.setItem('profile_reminders_enabled', value.toString());

    if (!value) {
      // Cancel all scheduled profile reminder notifications
      await Notifications.cancelAllScheduledNotificationsAsync();
    }
  };

  return (
    <View>
      <Text>Profile setup reminders</Text>
      <Switch value={remindersEnabled} onValueChange={handleToggle} />
    </View>
  );
}
```

### Testing
**Test file location:** `mindmirror-mobile/__tests__/notifications.test.ts`

**Test standards:**
- Notification scheduling tests (mock Expo Notifications)
- Deep linking tests (notification tap â†’ navigate to chat)
- Settings toggle tests

**Testing frameworks:**
- Jest
- Mock Expo Notifications API
- Mock AsyncStorage

**Specific testing requirements:**
- Test notification scheduled 24 hours after skip
- Test notification content (title, body, data)
- Test tapping notification navigates to chat
- Test notification not sent if already sent (duplicate prevention)
- Test settings toggle cancels scheduled notifications

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 10 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
