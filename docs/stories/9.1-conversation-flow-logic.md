# Story 9.1: Conversation Flow Logic

## Status
Draft

## Story
**As a** developer
**I want** PydanticAI agent to guide users through onboarding questions
**so that** the conversation feels natural and extracts required profile data

## Acceptance Criteria

1. Conversation sequence: Name → Vertical selection → Eating questions (weight, height, preferences) → Movement questions (training, goals) → Confirmation
2. Agent handles edge cases: Invalid input ("I weigh potato") → clarifying question, Off-topic question → redirect
3. Progress indicator updates after each question (1 of 7, 2 of 7, etc.)
4. Confirmation step shows extracted data as editable cards
5. User can edit previous answers in confirmation screen

## Tasks / Subtasks

- [ ] Define conversation state machine (AC: 1)
  - [ ] States: INTRO → NAME → VERTICAL → EATING_WEIGHT → EATING_HEIGHT → EATING_PREF → MOVEMENT_TRAINING → MOVEMENT_GOALS → CONFIRM → COMPLETE
  - [ ] Transitions: Each question advances to next state
  - [ ] Store current state in Redis conversation metadata

- [ ] Implement question prompts (AC: 1)
  - [ ] INTRO: "Hi! I'm here to help you get the most out of MindMirror. What's your name?"
  - [ ] VERTICAL: "Great to meet you, [Name]! What would you like to set up today?" [Workouts & Movement] button
  - [ ] EATING_WEIGHT: "Let's start with a few basics. What's your current weight?"
  - [ ] EATING_HEIGHT: "Got it. And your height?"
  - [ ] EATING_PREF: "Do you have any eating preferences?" [Omnivore] [Vegetarian] [Vegan] buttons
  - [ ] MOVEMENT_TRAINING: "What type of training do you prefer?" [Strength] [Running] [Yoga] buttons
  - [ ] MOVEMENT_GOALS: "What are your fitness goals?" [Build muscle] [Lose fat] [Endurance] (multi-select)
  - [ ] CONFIRM: "Just to confirm:" [editable cards]

- [ ] Implement input validation (AC: 2)
  - [ ] Weight: Must be numeric, 50-500 lbs or 20-200 kg
  - [ ] Height: Must be numeric, 4'0"-7'0" or 120-220 cm
  - [ ] Invalid input → "I didn't catch that. Could you confirm your weight in pounds or kilograms?"
  - [ ] Off-topic question → "I'm here to help with your fitness profile. Let's get back to the questions..."

- [ ] Implement confirmation screen logic (AC: 4, 5)
  - [ ] Extract structured data: name, eating profile, movement profile
  - [ ] Render as editable cards
  - [ ] User can tap "Edit" → re-opens that question
  - [ ] "Looks good!" button → sends to profile extraction

- [ ] Add progress tracking (AC: 3)
  - [ ] Calculate progress: current_question_index / total_questions
  - [ ] Send progress updates to mobile UI
  - [ ] Show "2 of 7 questions" in chat header

## Dev Notes

### Relevant Source Tree
- **Location:** `onboarding-agent/conversation_flow.py`
- **PydanticAI:** Agent with state management

### Key Technical Details
- PydanticAI supports stateful conversations via system prompts
- Redis stores conversation state + current question index
- WebSocket sends progress updates to mobile UI

### Implementation Notes
```python
# Conversation state machine
from enum import Enum

class ConversationState(Enum):
    INTRO = "intro"
    NAME = "name"
    VERTICAL = "vertical"
    EATING_WEIGHT = "eating_weight"
    EATING_HEIGHT = "eating_height"
    EATING_PREF = "eating_pref"
    MOVEMENT_TRAINING = "movement_training"
    MOVEMENT_GOALS = "movement_goals"
    CONFIRM = "confirm"
    COMPLETE = "complete"

# Question prompts
QUESTIONS = {
    ConversationState.INTRO: "Hi! I'm here to help you get the most out of MindMirror. What's your name?",
    ConversationState.VERTICAL: "Great to meet you, {name}! What would you like to set up today?",
    ConversationState.EATING_WEIGHT: "Let's start with a few basics. What's your current weight?",
    # ... etc
}

# Progress calculation
def get_progress(state: ConversationState) -> dict:
    total_questions = 7
    question_index = list(ConversationState).index(state)
    return {
        "current": question_index + 1,
        "total": total_questions,
        "percentage": (question_index + 1) / total_questions * 100
    }
```

### Testing
**Test file location:** `onboarding-agent/tests/test_conversation_flow.py`

**Test standards:**
- Unit tests for state transitions
- Integration test: Mock conversation start-to-finish
- Validation tests for edge cases

**Testing frameworks:**
- pytest
- Mock PydanticAI agent

**Specific testing requirements:**
- Test full conversation flow (all 7 questions)
- Test invalid input handling (weight="potato" → clarifying question)
- Test off-topic question handling
- Test confirmation screen renders extracted data
- Test edit functionality updates state

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 9 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
