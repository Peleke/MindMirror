# Story 3.5: Secret Manager Hardening

## Status
Draft

## Story
**As a** security engineer
**I want** all secrets (OPENAI_API_KEY, DATABASE_URL, Supabase keys) in Secret Manager with volume mounts
**So that** credentials aren't exposed in env vars or logs; least-privilege IAM enforced

## Acceptance Criteria

1. **All secrets in Secret Manager:** `OPENAI_API_KEY`, `DATABASE_URL`, `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `SUPABASE_JWT_SECRET`, and any other sensitive values stored as secrets
2. **Volume mounts (not env vars):** Cloud Run services access secrets via volume mounts (e.g., `/secrets/openai-api-key`) instead of environment variables
3. **Least-privilege IAM:** Each service has dedicated service account with minimal IAM roles (e.g., `practices_service` can only access `practices_db_password`, not other secrets)
4. **No secrets in OpenTofu state:** Secrets referenced via `data` source (not `resource` creation) to avoid storing values in state file
5. **Rotation-ready:** Secrets support versioning (can rotate without downtime by creating new version)
6. **Audit logging:** Secret Manager audit logs enabled (track who accessed which secrets when)
7. **Documentation:** Runbook documents secret creation, rotation, and emergency access procedures

## Tasks / Subtasks

- [ ] **Create secrets in Secret Manager** (AC: 1)
  - [ ] Create production secrets via gcloud CLI:
    ```bash
    # OpenAI API Key
    echo -n "sk-proj-..." | gcloud secrets create production-openai-api-key --data-file=-

    # Database URLs (one per database)
    echo -n "postgresql://..." | gcloud secrets create production-database-url --data-file=-
    echo -n "postgresql://..." | gcloud secrets create production-habits-db-url --data-file=-
    echo -n "postgresql://..." | gcloud secrets create production-movements-db-url --data-file=-
    echo -n "postgresql://..." | gcloud secrets create production-practices-db-url --data-file=-
    echo -n "postgresql://..." | gcloud secrets create production-users-db-url --data-file=-

    # Supabase credentials
    echo -n "https://[project].supabase.co" | gcloud secrets create production-supabase-url --data-file=-
    echo -n "eyJhbGc..." | gcloud secrets create production-supabase-anon-key --data-file=-
    echo -n "eyJhbGc..." | gcloud secrets create production-supabase-service-role-key --data-file=-
    echo -n "your-jwt-secret" | gcloud secrets create production-supabase-jwt-secret --data-file=-
    ```
  - [ ] Verify secrets created: `gcloud secrets list`

- [ ] **Create service accounts for each service** (AC: 3)
  - [ ] Create dedicated service accounts via OpenTofu:
    ```hcl
    resource "google_service_account" "agent_service" {
      account_id   = "agent-service"
      display_name = "Agent Service"
    }

    resource "google_service_account" "journal_service" {
      account_id   = "journal-service"
      display_name = "Journal Service"
    }

    # ... (repeat for all 7 services + gateway)
    ```
  - [ ] Assign service accounts to Cloud Run services in OpenTofu

- [ ] **Grant least-privilege IAM permissions** (AC: 3)
  - [ ] Grant Secret Accessor role for each service (only to secrets it needs):
    ```hcl
    # Agent service can access: OpenAI API key, main database URL, Supabase keys
    resource "google_secret_manager_secret_iam_member" "agent_openai" {
      secret_id = google_secret_manager_secret.openai_api_key.id
      role      = "roles/secretmanager.secretAccessor"
      member    = "serviceAccount:${google_service_account.agent_service.email}"
    }

    resource "google_secret_manager_secret_iam_member" "agent_database" {
      secret_id = google_secret_manager_secret.database_url.id
      role      = "roles/secretmanager.secretAccessor"
      member    = "serviceAccount:${google_service_account.agent_service.email}"
    }

    # Practices service can access: ONLY practices database URL (not others)
    resource "google_secret_manager_secret_iam_member" "practices_database" {
      secret_id = google_secret_manager_secret.practices_db_url.id
      role      = "roles/secretmanager.secretAccessor"
      member    = "serviceAccount:${google_service_account.practices_service.email}"
    }

    # ... (repeat for all services with minimal permissions)
    ```

- [ ] **Configure volume mounts in Cloud Run** (AC: 2)
  - [ ] Update OpenTofu for Cloud Run v2 services:
    ```hcl
    resource "google_cloud_run_v2_service" "agent_service" {
      # ... other config ...

      template {
        service_account = google_service_account.agent_service.email

        volumes {
          name = "openai-api-key"
          secret {
            secret       = google_secret_manager_secret.openai_api_key.secret_id
            default_mode = 0444  # Read-only
            items {
              version = "latest"
              path    = "openai-api-key"
            }
          }
        }

        volumes {
          name = "database-url"
          secret {
            secret       = google_secret_manager_secret.database_url.secret_id
            default_mode = 0444
            items {
              version = "latest"
              path    = "database-url"
            }
          }
        }

        containers {
          # ... other container config ...

          volume_mounts {
            name       = "openai-api-key"
            mount_path = "/secrets"
          }

          volume_mounts {
            name       = "database-url"
            mount_path = "/secrets"
          }

          # Application reads secrets from files:
          # /secrets/openai-api-key
          # /secrets/database-url
        }
      }
    }
    ```

- [ ] **Update application code to read secrets from files** (AC: 2)
  - [ ] Update services to read from `/secrets/*` instead of `process.env.*`:
    ```python
    # Before (environment variable):
    OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')

    # After (volume mount):
    with open('/secrets/openai-api-key', 'r') as f:
        OPENAI_API_KEY = f.read().strip()
    ```
  - [ ] Apply to all services that use secrets
  - [ ] Test locally using mock secret files

- [ ] **Use data sources in OpenTofu (not resources)** (AC: 4)
  - [ ] Reference existing secrets instead of managing them:
    ```hcl
    # ❌ DON'T DO THIS (stores secret value in state):
    resource "google_secret_manager_secret" "openai_api_key" {
      secret_id = "production-openai-api-key"
      # ...
    }

    # ✅ DO THIS (references secret by name, no value in state):
    data "google_secret_manager_secret" "openai_api_key" {
      secret_id = "production-openai-api-key"
    }
    ```
  - [ ] Update all secret references in OpenTofu
  - [ ] Verify OpenTofu state file doesn't contain secret values: `grep -i "api_key\|password" terraform.tfstate`

- [ ] **Enable secret versioning** (AC: 5)
  - [ ] Secrets already support versioning by default (no action needed)
  - [ ] Document rotation process:
    1. Create new version: `echo -n "new-value" | gcloud secrets versions add production-openai-api-key --data-file=-`
    2. Cloud Run automatically uses `latest` version
    3. Rollback if needed: Pin to specific version in OpenTofu

- [ ] **Enable audit logging** (AC: 6)
  - [ ] Enable Data Access audit logs for Secret Manager:
    ```hcl
    resource "google_project_iam_audit_config" "secret_manager" {
      project = var.project_id
      service = "secretmanager.googleapis.com"

      audit_log_config {
        log_type = "DATA_READ"  # Log all secret accesses
      }
    }
    ```
  - [ ] Verify audit logs in Cloud Logging: Filter by `resource.type="secretmanager.googleapis.com/Secret"`

- [ ] **Write runbook documentation** (AC: 7)
  - [ ] Create `docs/infrastructure/secret-manager-runbook.md`
  - [ ] Document secret creation process
  - [ ] Document rotation process (create new version, validate, rollback if needed)
  - [ ] Document emergency access (how to manually retrieve secret if needed)
  - [ ] Document troubleshooting (permission denied, secret not found, etc.)

## Dev Notes

### Relevant Source Tree
- **OpenTofu:** `infra/secrets.tf` (to be created), `infra/modules/*/main.tf` (service configs)
- **Service Code:** All services that read secrets (agent, journal, gateway, etc.)
- **Documentation:** `docs/infrastructure/secret-manager-runbook.md` (to be created)

### Key Technical Details

**Why Volume Mounts vs. Environment Variables:**
- **Env vars:** Visible in process listings, logs, crash dumps (security risk)
- **Volume mounts:** Read from filesystem, not exposed in environment (more secure)
- **Best practice:** Use volume mounts for sensitive data, env vars for non-sensitive config

**Secret Manager Versioning:**
- Each secret can have multiple versions (e.g., v1, v2, v3)
- Cloud Run can pin to specific version or use `latest`
- Rotation process: Create new version → Cloud Run auto-updates → test → disable old version

**Least-Privilege IAM:**
- **Principle:** Each service should only access secrets it needs (nothing more)
- **Example:** `practices_service` needs practices DB password, NOT OpenAI API key
- **Implementation:** Grant `roles/secretmanager.secretAccessor` on per-secret basis (not project-wide)

**Cost:**
- Secret Manager: $0.06 per 10,000 access operations (negligible for alpha)
- Storage: $0.05 per secret version per month (minimal cost for ~10 secrets)

### Implementation Notes

**Secret Naming Convention:**
- Format: `{environment}-{service}-{secret-name}` (e.g., `production-agent-openai-api-key`)
- OR: `{environment}-{secret-name}` if shared (e.g., `production-database-url`)
- Consistent naming helps with automation and auditing

**Application Code Updates:**
- Python services: Use `pathlib` or `open()` to read secret files
- Node.js services: Use `fs.readFileSync('/secrets/...')` or equivalent
- Ensure error handling (file not found → fail fast with clear error)

**Testing Locally:**
- Create mock secret files in `/tmp/secrets/` for local development
- Use environment variable fallback: `SECRET = read_secret_file() or os.getenv('SECRET')`

**Rotation Process:**
```bash
# 1. Create new secret version
echo -n "new-value" | gcloud secrets versions add production-openai-api-key --data-file=-

# 2. Cloud Run services automatically pick up new version (may take a few minutes)

# 3. Test production (verify new value works)

# 4. If broken, rollback to previous version:
gcloud secrets versions disable [version] --secret=production-openai-api-key

# OR pin Cloud Run to specific version in OpenTofu
```

### Security Considerations

**Service Account Compromise:**
- If service account is compromised, attacker can only access secrets granted to that account
- Least-privilege IAM limits blast radius
- Monitor audit logs for unusual access patterns

**Secret Leakage:**
- Never log secret values (even truncated)
- Never include secrets in error messages
- Use placeholder in logs: `"OpenAI API key: [REDACTED]"`

**State File Security:**
- OpenTofu state file stored in GCS bucket (encrypted at rest)
- Use `data` sources for secrets (not `resource`) to avoid storing values in state
- Limit access to state file (only DevOps team)

**Emergency Access:**
- If all Cloud Run services are down, secrets can be retrieved manually:
  ```bash
  gcloud secrets versions access latest --secret=production-database-url
  ```
- Require MFA for manual secret access (GCP IAM policy)

### Testing

**Test file location:** OpenTofu validation + manual secret access testing

**Test standards:**
- All services can access their required secrets
- Services cannot access secrets they don't need (least-privilege enforced)
- No secret values in OpenTofu state file
- Audit logs capture secret access events

**Testing frameworks:**
- OpenTofu plan/apply validation
- gcloud CLI for secret access testing
- Manual application testing (services can read secrets from volume mounts)

**Specific testing requirements:**

1. **Least-Privilege IAM Test:**
   ```bash
   # Impersonate practices_service service account
   gcloud auth application-default login --impersonate-service-account=practices-service@[project].iam.gserviceaccount.com

   # Try to access practices DB secret (should succeed)
   gcloud secrets versions access latest --secret=production-practices-db-url
   # Expected: Success

   # Try to access OpenAI API key (should fail - not granted access)
   gcloud secrets versions access latest --secret=production-openai-api-key
   # Expected: Permission denied error
   ```

2. **Volume Mount Test:**
   ```bash
   # Deploy service with volume mount
   # SSH into Cloud Run instance (or check logs)
   # Verify secret file exists and is readable
   ls -la /secrets/
   cat /secrets/openai-api-key  # Should show secret value
   ```

3. **State File Validation:**
   ```bash
   # Pull OpenTofu state
   cd infra && tofu state pull > state.json

   # Search for secret values (should be empty)
   grep -i "sk-proj\|eyJhbGc\|postgresql://" state.json
   # Expected: No matches (secrets not stored in state)
   ```

4. **Audit Log Validation:**
   ```bash
   # Check Cloud Logging for secret access events
   gcloud logging read "resource.type=secretmanager.googleapis.com/Secret \
     protoPayload.methodName=google.cloud.secretmanager.v1.SecretManagerService.AccessSecretVersion" \
     --limit=10

   # Expected: Log entries showing which service account accessed which secret
   ```

5. **Rotation Test:**
   ```bash
   # Rotate OpenAI API key (create new version)
   echo -n "sk-proj-NEW-KEY" | gcloud secrets versions add production-openai-api-key --data-file=-

   # Wait ~2 minutes for Cloud Run to pick up new version
   # Test agent_service functionality (should use new key)

   # Rollback if broken:
   gcloud secrets versions disable [new-version] --secret=production-openai-api-key
   gcloud secrets versions enable [old-version] --secret=production-openai-api-key
   ```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |
| 2025-10-18 | v2.0 | Complete rewrite: Secret Manager with volume mounts, least-privilege IAM, versioning, audit logging, rotation runbook | Alex (DevOps Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
