# Story 3.2: Supabase Separate Production Config

## Status
Draft

## Story
**As a** platform engineer
**I want** production environment to use dedicated Supabase project (not staging)
**so that** alpha user data is isolated and we can implement stricter security policies

## Acceptance Criteria

1. New Supabase project created for production (separate from staging)
2. Environment variables updated: SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
3. RLS (Row-Level Security) policies enabled on vouchers table
4. Auth configuration: Email confirmation required, JWT expiry 24 hours (vs 7 days staging)
5. Separate OAuth providers configured (if needed for future social login)
6. Terraform/automation creates Supabase resources (no manual ClickOps in console)
7. Database schema migrations applied to production Supabase

## Tasks / Subtasks

- [ ] Create new Supabase production project (AC: 1)
  - [ ] Use Supabase CLI: `supabase init` for new project
  - [ ] Create project via Supabase Dashboard or CLI
  - [ ] Note down project URL, anon key, service role key

- [ ] Update environment variables (AC: 2)
  - [ ] Create `env.production` file with new Supabase credentials
  - [ ] Update SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
  - [ ] Store secrets in Google Secret Manager
  - [ ] Update Cloud Run services to use production secrets

- [ ] Configure RLS policies (AC: 3)
  - [ ] Enable RLS on vouchers table
  - [ ] Create policy: Users can only read their own vouchers
  - [ ] Create policy: Service role can create/update all vouchers
  - [ ] Test RLS policies with SQL queries

- [ ] Configure Auth settings (AC: 4)
  - [ ] Set JWT expiry to 24 hours (vs 7 days in staging)
  - [ ] Enable email confirmation required for signup
  - [ ] Configure email templates (signup confirmation, password reset)
  - [ ] Test auth flow end-to-end

- [ ] (Optional) Configure OAuth providers (AC: 5)
  - [ ] **Skip for alpha unless required**
  - [ ] If needed: Configure Google/Apple OAuth
  - [ ] Test OAuth login flow

- [ ] Automate Supabase setup (AC: 6)
  - [ ] Create setup script or Terraform module for Supabase
  - [ ] Script should be idempotent (running twice doesn't break)
  - [ ] Validate prerequisites (Supabase CLI, credentials)

- [ ] Apply database migrations (AC: 7)
  - [ ] Run `supabase db push` to apply schema migrations
  - [ ] Verify tables, indexes, RLS policies created
  - [ ] Test database connectivity from Cloud Run services

## Dev Notes

### Relevant Source Tree
- **Supabase Config:** Supabase CLI configuration files
- **Environment Files:** `env.production`, `env.staging`
- **Secrets Management:** Google Secret Manager
- **Database Migrations:** `src/alembic-config/` (may need Supabase-specific migrations)

### Key Technical Details
- Supabase provides PostgreSQL database + auth + realtime + storage
- RLS policies enforce data access control at database level
- JWT expiry controls how long auth tokens are valid
- Email confirmation prevents typo-based account hijacking
- Supabase CLI: `supabase init`, `supabase db push`, `supabase db reset`

### Implementation Notes
- Supabase projects are environment-specific (dev, staging, production)
- Use `.env.production` for production-specific configuration
- Store Supabase service role key in Secret Manager (sensitive)
- RLS policies should be version-controlled (SQL migrations)
- Test RLS policies thoroughly to prevent data leaks

### SECURITY CONSIDERATIONS
- **JWT Expiry:** 24 hours (vs 7 days staging) - more secure, requires more frequent re-auth
- **Email Confirmation:** Required for signup - prevents accidental account creation
- **RLS Policies:** Enforce data isolation - users can't access other users' data
- **Service Role Key:** Highly sensitive - store in Secret Manager, never commit to git

### Testing
**Test file location:** Manual testing + SQL query validation

**Test standards:**
- RLS policies tested with SQL queries (simulate user access)
- Auth flow tested end-to-end (signup, login, logout)
- Environment variables validated (services can connect to Supabase)

**Testing frameworks:**
- Manual Supabase Dashboard testing
- curl commands to test auth endpoints
- SQL queries to test RLS policies

**Specific testing requirements:**
- Test RLS policy: User A cannot read User B's vouchers
- Test RLS policy: Service role can create vouchers for any user
- Test auth: Signup requires email confirmation
- Test auth: JWT expires after 24 hours (force re-login)
- Test database connectivity from Cloud Run services

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
