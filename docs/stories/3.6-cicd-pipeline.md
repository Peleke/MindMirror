# Story 3.6: GitHub Actions CI/CD Pipeline

## Status
Draft - **PHASE 2** (implement after Phase 1 deployment, while users sleep on email)

## Story
**As a** platform engineer
**I want** tag-triggered GitHub Actions pipeline for backend services with non-blocking tests and manual approval
**So that** post-launch deployments are automated, safe, and don't require manual tofu apply

## Acceptance Criteria

1. **Tag-triggered workflow:** Pipeline triggers on git tag push (e.g., `git tag v1.0.1 && git push --tags`)
2. **Path-based build isolation:** Changes to `src/agent_service/` only build/deploy agent_service (not all services)
3. **Backend services only:** Pipeline deploys 7 microservices + gateway (not web/mobile apps)
4. **Non-blocking tests:** Unit + integration tests run, failures logged but don't block deployment
5. **Manual approval gate:** Deployment requires manual approval after tests complete
6. **Deployment to Cloud Run:** Pipeline builds Docker images, pushes to GCR/Artifact Registry, deploys to Cloud Run
7. **Rollback support:** Pipeline supports rollback to previous tag/deployment
8. **Deployment notifications:** Pipeline sends notifications (Slack/email) on success/failure

## Tasks / Subtasks

- [ ] **Create GitHub Actions workflow file** (AC: 1, 2, 3)
  - [ ] Create `.github/workflows/deploy-backend.yml`:
    ```yaml
    name: Deploy Backend Services

    on:
      push:
        tags:
          - 'v*'  # Trigger on version tags (e.g., v1.0.1)

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_REGION: us-east1
      REGISTRY: us-east1-docker.pkg.dev

    jobs:
      detect-changes:
        name: Detect Changed Services
        runs-on: ubuntu-latest
        outputs:
          agent: ${{ steps.filter.outputs.agent }}
          journal: ${{ steps.filter.outputs.journal }}
          habits: ${{ steps.filter.outputs.habits }}
          meals: ${{ steps.filter.outputs.meals }}
          movements: ${{ steps.filter.outputs.movements }}
          practices: ${{ steps.filter.outputs.practices }}
          users: ${{ steps.filter.outputs.users }}
          gateway: ${{ steps.filter.outputs.gateway }}
        steps:
          - uses: actions/checkout@v4
          - uses: dorny/paths-filter@v2
            id: filter
            with:
              filters: |
                agent:
                  - 'src/agent_service/**'
                journal:
                  - 'src/journal_service/**'
                habits:
                  - 'habits_service/**'
                meals:
                  - 'meals_service/**'
                movements:
                  - 'movements_service/**'
                practices:
                  - 'practices_service/**'
                users:
                  - 'users_service/**'
                gateway:
                  - 'mesh/**'
    ```

- [ ] **Implement test execution jobs** (AC: 4)
  - [ ] Add test jobs for each service:
    ```yaml
    test-agent:
      name: Test Agent Service
      runs-on: ubuntu-latest
      needs: detect-changes
      if: needs.detect-changes.outputs.agent == 'true'
      continue-on-error: true  # Non-blocking (don't fail pipeline)
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-python@v4
          with:
            python-version: '3.11'
        - name: Install dependencies
          run: |
            cd src/agent_service
            pip install poetry
            poetry install
        - name: Run tests
          run: |
            cd src/agent_service
            poetry run pytest --cov=agent_service
        - name: Upload test results
          if: always()
          uses: actions/upload-artifact@v3
          with:
            name: agent-test-results
            path: src/agent_service/test-results/

    # Repeat for other services (journal, habits, etc.)
    ```

- [ ] **Implement build and push jobs** (AC: 6)
  - [ ] Add build jobs for each service:
    ```yaml
    build-agent:
      name: Build Agent Service
      runs-on: ubuntu-latest
      needs: [detect-changes, test-agent]
      if: needs.detect-changes.outputs.agent == 'true'
      steps:
        - uses: actions/checkout@v4

        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v1
          with:
            credentials_json: ${{ secrets.GCP_SA_KEY }}

        - name: Set up Cloud SDK
          uses: google-github-actions/setup-gcloud@v1

        - name: Configure Docker for Artifact Registry
          run: gcloud auth configure-docker ${{ env.REGISTRY }}

        - name: Build and push Docker image
          run: |
            IMAGE="${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/mindmirror/agent-service:${{ github.ref_name }}"
            docker build -t $IMAGE -f src/agent_service/Dockerfile .
            docker push $IMAGE
            echo "IMAGE=$IMAGE" >> $GITHUB_ENV

        - name: Output image name
          id: image
          run: echo "image=${{ env.IMAGE }}" >> $GITHUB_OUTPUT

    # Repeat for other services
    ```

- [ ] **Implement manual approval gate** (AC: 5)
  - [ ] Add approval job:
    ```yaml
    approve-deployment:
      name: Approve Deployment
      runs-on: ubuntu-latest
      needs: [build-agent, build-journal, build-habits]  # All build jobs
      environment:
        name: production
        url: https://gateway-prod-xyz.a.run.app
      steps:
        - name: Manual approval required
          run: |
            echo "Deployment approved by: ${{ github.actor }}"
            echo "Tag: ${{ github.ref_name }}"
    ```
  - [ ] Configure GitHub environment protection rules (Settings → Environments → production → Required reviewers)

- [ ] **Implement deployment jobs** (AC: 6)
  - [ ] Add deployment jobs for each service:
    ```yaml
    deploy-agent:
      name: Deploy Agent Service
      runs-on: ubuntu-latest
      needs: [approve-deployment, build-agent]
      if: needs.detect-changes.outputs.agent == 'true'
      steps:
        - name: Authenticate to Google Cloud
          uses: google-github-actions/auth@v1
          with:
            credentials_json: ${{ secrets.GCP_SA_KEY }}

        - name: Deploy to Cloud Run
          run: |
            gcloud run deploy agent-service \
              --image=${{ needs.build-agent.outputs.image }} \
              --region=${{ env.GCP_REGION }} \
              --platform=managed \
              --allow-unauthenticated=false
              # Other Cloud Run flags (min-instances, etc.)

    # Repeat for other services
    ```

- [ ] **Implement rollback workflow** (AC: 7)
  - [ ] Create `.github/workflows/rollback-backend.yml`:
    ```yaml
    name: Rollback Backend Services

    on:
      workflow_dispatch:
        inputs:
          service:
            description: 'Service to rollback'
            required: true
            type: choice
            options:
              - agent-service
              - journal-service
              - users-service
              # ... all services
          tag:
            description: 'Tag to rollback to (e.g., v1.0.0)'
            required: true

    jobs:
      rollback:
        runs-on: ubuntu-latest
        steps:
          - name: Authenticate to Google Cloud
            uses: google-github-actions/auth@v1
            with:
              credentials_json: ${{ secrets.GCP_SA_KEY }}

          - name: Rollback deployment
            run: |
              IMAGE="${{ env.REGISTRY }}/${{ env.GCP_PROJECT_ID }}/mindmirror/${{ inputs.service }}:${{ inputs.tag }}"
              gcloud run deploy ${{ inputs.service }} \
                --image=$IMAGE \
                --region=${{ env.GCP_REGION }} \
                --platform=managed
    ```

- [ ] **Implement notifications** (AC: 8)
  - [ ] Add notification steps to workflow:
    ```yaml
    notify:
      name: Send Deployment Notification
      runs-on: ubuntu-latest
      needs: [deploy-agent, deploy-journal]  # All deploy jobs
      if: always()
      steps:
        - name: Send Slack notification
          uses: slackapi/slack-github-action@v1
          with:
            webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
            payload: |
              {
                "text": "Backend deployment ${{ job.status }}",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*Deployment:* ${{ github.ref_name }}\n*Status:* ${{ job.status }}\n*Triggered by:* ${{ github.actor }}"
                    }
                  }
                ]
              }
    ```

- [ ] **Configure GitHub secrets** (AC: all)
  - [ ] Add required secrets to GitHub repo (Settings → Secrets and variables → Actions):
    - `GCP_PROJECT_ID`: GCP project ID (e.g., `mindmirror-prod`)
    - `GCP_SA_KEY`: GCP service account key (JSON) with Cloud Run Admin, Artifact Registry Writer roles
    - `SLACK_WEBHOOK_URL`: Slack incoming webhook URL (optional)

- [ ] **Test pipeline in non-production** (AC: all)
  - [ ] Create `v0.0.1-test` tag
  - [ ] Push tag: `git push --tags`
  - [ ] Verify workflow triggers
  - [ ] Verify path filters work (only changed services build)
  - [ ] Verify tests run (even if they fail)
  - [ ] Verify manual approval gate works
  - [ ] Verify deployment succeeds

## Dev Notes

### Relevant Source Tree
- **Workflows:** `.github/workflows/deploy-backend.yml`, `.github/workflows/rollback-backend.yml`
- **Dockerfiles:** `src/agent_service/Dockerfile`, `src/journal_service/Dockerfile`, etc.
- **Service Code:** All backend service directories

### Key Technical Details

**Tag-Based Deployment:**
- Developers create git tag when ready to deploy: `git tag v1.0.1`
- Tag name becomes Docker image tag (e.g., `agent-service:v1.0.1`)
- Benefits: Explicit deployment trigger, easy rollback (redeploy previous tag)

**Path-Based Filtering:**
- Uses `dorny/paths-filter` action to detect changed files
- Only builds/deploys services that changed
- Example: Change in `src/agent_service/` → only agent_service deploys
- Saves CI time and reduces deployment risk (don't deploy unchanged services)

**Non-Blocking Tests:**
- `continue-on-error: true` allows job to fail without stopping pipeline
- Test results uploaded as artifacts for manual review
- Trade-off: Speed vs. safety (acceptable for alpha, fix tests gradually)

**Manual Approval:**
- GitHub Environments feature provides approval gate
- Configured reviewers can approve/reject deployment
- Deployment pauses until approved (prevents accidental production deploy)

**Service Account Permissions:**
- GCP service account needs:
  - `roles/run.admin` (Cloud Run deployments)
  - `roles/artifactregistry.writer` (push Docker images)
  - `roles/iam.serviceAccountUser` (deploy as service account)

### Implementation Notes

**Docker Image Tagging Strategy:**
- Use git tag as image tag: `agent-service:v1.0.1`
- Always tag `latest` for convenience: `agent-service:latest`
- Avoids `:latest` in production (hard to rollback)

**Deployment Order:**
- No strict order required (services are independent)
- Gateway should deploy last (depends on mesh services)
- Consider deploying users_service first (highest priority)

**Rollback Process:**
1. Identify previous working tag (e.g., `v1.0.0`)
2. Run rollback workflow (manual trigger)
3. Select service and previous tag
4. Workflow redeploys old image to Cloud Run

**Alternative Trigger (On Merge to Main):**
- Current design: Tag-triggered (explicit control)
- Alternative: Trigger on merge to `main` branch (automatic)
- Trade-off: Automation vs. control (tag-triggered safer for alpha)

### Security Considerations

**Service Account Key Protection:**
- GCP service account key is HIGHLY SENSITIVE (full deployment access)
- Store in GitHub Secrets (encrypted at rest)
- Rotate periodically (every 90 days)
- Use Workload Identity Federation instead (more secure, no long-lived keys)

**Approval Bypass:**
- Require 1+ approvers in GitHub Environment settings
- Don't approve own deployments (separation of duties)
- Log all approvals for audit trail

**Docker Image Security:**
- Scan images for vulnerabilities (use Trivy or similar)
- Sign images (Docker Content Trust or Sigstore)
- Use minimal base images (e.g., `python:3.11-slim`)

### Testing

**Test file location:** GitHub Actions workflow testing (create test tags)

**Test standards:**
- Pipeline triggers on tag push
- Path filters correctly identify changed services
- Tests run and results uploaded (even if tests fail)
- Manual approval required before deployment
- Deployment succeeds and service is updated
- Rollback workflow works

**Testing frameworks:**
- GitHub Actions (workflow execution)
- Manual testing of tag creation and deployment

**Specific testing requirements:**

1. **Trigger Test:**
   ```bash
   # Create test tag
   git tag v0.0.1-test
   git push --tags

   # Expected: Workflow triggers in GitHub Actions tab
   ```

2. **Path Filter Test:**
   ```bash
   # Make change to agent_service only
   echo "# Test change" >> src/agent_service/README.md
   git add . && git commit -m "test: agent change"
   git tag v0.0.2-test && git push --tags

   # Expected: Only agent_service build/deploy jobs run, others skipped
   ```

3. **Non-Blocking Test:**
   ```bash
   # Introduce failing test in agent_service
   # Create tag and push
   git tag v0.0.3-test && git push --tags

   # Expected: Test job fails, but build/deploy jobs still run
   # Check workflow: Test job shows failure, deployment proceeds
   ```

4. **Manual Approval Test:**
   ```bash
   # Create tag, workflow runs
   git tag v0.0.4-test && git push --tags

   # Expected: Workflow pauses at "approve-deployment" job
   # GitHub → Actions → Deploy Backend → Review deployment → Approve
   # Deployment proceeds after approval
   ```

5. **Rollback Test:**
   ```bash
   # Deploy v0.0.5-test (with intentional bug)
   git tag v0.0.5-test && git push --tags
   # Approve and deploy

   # Rollback to v0.0.4-test:
   # GitHub → Actions → Rollback Backend → Run workflow
   # Input: service=agent-service, tag=v0.0.4-test
   # Expected: agent-service reverts to v0.0.4-test image
   ```

6. **Notification Test:**
   ```bash
   # Configure Slack webhook in GitHub Secrets
   # Deploy any tag
   git tag v0.0.6-test && git push --tags

   # Expected: Slack message sent on deployment success/failure
   ```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | v1.0 | New story: GitHub Actions CI/CD pipeline with tag-triggered deployments, non-blocking tests, manual approval for backend services | Alex (DevOps Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
