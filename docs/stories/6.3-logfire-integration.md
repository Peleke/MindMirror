# Story 6.3: Logfire Integration

## Status
Draft

## Story
**As a** developer
**I want** all conversations logged to Logfire for monitoring and debugging
**so that** I can track completion rates, identify drop-off points, and debug extraction failures

## Acceptance Criteria

1. Logfire SDK initialized in FastAPI app
2. Events logged:
   - `onboarding.started` (user_id, timestamp)
   - `onboarding.message` (user_id, role, content_length, timestamp)
   - `onboarding.completed` (user_id, duration, extracted_profile)
   - `onboarding.skipped` (user_id, timestamp)
   - `onboarding.error` (user_id, error_type, stack_trace)
3. Logfire dashboard shows completion rate metric, average duration metric, drop-off funnel
4. No PII logged in plain text (use user_id, not email/name)

## Tasks / Subtasks

- [ ] Set up Logfire account and SDK (AC: 1)
  - [ ] Create Logfire account at https://logfire.pydantic.dev/
  - [ ] Generate API token
  - [ ] Add `LOGFIRE_TOKEN` to Modal secrets
  - [ ] Install Logfire SDK: `pip install logfire`

- [ ] Initialize Logfire in FastAPI app (AC: 1)
  - [ ] Add Logfire middleware to FastAPI
  - [ ] Configure auto-instrumentation for HTTP requests
  - [ ] Add custom span context for conversation tracking

- [ ] Implement event logging (AC: 2)
  - [ ] Log `onboarding.started` when user opens chat
  - [ ] Log `onboarding.message` after each agent/user message (content_length only, not full content)
  - [ ] Log `onboarding.completed` when profile successfully extracted
  - [ ] Log `onboarding.skipped` when user skips
  - [ ] Log `onboarding.error` for exceptions (with stack trace)

- [ ] Create Logfire dashboard (AC: 3)
  - [ ] Add metric: Completion rate (completed / total started)
  - [ ] Add metric: Average duration (time from start to complete)
  - [ ] Add funnel: Question-by-question drop-off visualization
  - [ ] Add alert: >3 errors from same user within 1 hour

- [ ] Ensure PII compliance (AC: 4)
  - [ ] Review all log statements, remove email/name fields
  - [ ] Use user_id only for identification
  - [ ] Hash sensitive data if needed (weight, height)

## Dev Notes

### Relevant Source Tree
- **Location:** `onboarding-agent/app.py` (Logfire middleware)
- **Logfire Docs:** https://docs.pydantic.dev/logfire/

### Key Technical Details
- Logfire is Pydantic-native observability (tight PydanticAI integration)
- Auto-instruments FastAPI requests, database queries, external API calls
- Custom spans for conversation flow tracking
- Retention: 30 days on free tier

### Implementation Notes
```python
# Example Logfire integration
import logfire
from fastapi import FastAPI

# Initialize Logfire
logfire.configure(token=os.getenv("LOGFIRE_TOKEN"))

app = FastAPI()
logfire.instrument_fastapi(app)

# Custom event logging
def log_onboarding_event(event_type: str, user_id: str, **kwargs):
    with logfire.span(f"onboarding.{event_type}"):
        logfire.info(
            f"Onboarding {event_type}",
            user_id=user_id,
            **kwargs
        )

# Usage in conversation flow
log_onboarding_event("started", user_id=user_id)
log_onboarding_event("message", user_id=user_id, role="agent", content_length=len(message))
log_onboarding_event("completed", user_id=user_id, duration=elapsed_time)
```

### Testing
**Test file location:** `onboarding-agent/tests/test_logfire.py`

**Test standards:**
- Unit tests with Logfire mocks (verify events logged)
- Integration test: Validate events appear in Logfire dashboard
- PII compliance test: Scan logs for email/name patterns

**Testing frameworks:**
- pytest
- Logfire test utilities

**Specific testing requirements:**
- Verify all 5 event types logged correctly
- Confirm no PII in logs (email, full name)
- Test alert triggers for high error rates
- Validate dashboard metrics calculate correctly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 6 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
