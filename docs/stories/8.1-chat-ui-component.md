# Story 8.1: Chat UI Component

## Status
Draft

## Story
**As a** mobile developer
**I want** a chat UI component for conversational onboarding
**so that** users can interact with the agent naturally

## Acceptance Criteria

1. Chat interface with message list (scrollable, auto-scroll to latest)
2. Agent messages: Left-aligned, light gray bubble, agent icon
3. User messages: Right-aligned, blue bubble (brand color)
4. Input field: Bottom sheet with text input + send button
5. Typing indicator: "..." animation when agent is composing response
6. Quick reply buttons for predefined options (eating preferences, training modalities)
7. Supports keyboard dismissal on scroll
8. Works on iOS and Android (React Native)

## Tasks / Subtasks

- [ ] Create chat UI component structure (AC: 1, 7, 8)
  - [ ] Create `OnboardingChat.tsx` component
  - [ ] Use FlatList for message list (optimized for scrolling)
  - [ ] Implement auto-scroll to latest message
  - [ ] Add keyboard dismiss on scroll

- [ ] Implement message bubbles (AC: 2, 3)
  - [ ] Create `MessageBubble.tsx` component
  - [ ] Agent messages: Left align, light gray (#F0F0F0), agent icon
  - [ ] User messages: Right align, blue brand color, no icon
  - [ ] Add timestamp (small gray text below bubble)

- [ ] Implement input field (AC: 4)
  - [ ] Text input with placeholder "Type a message..."
  - [ ] Send button (disabled when input empty)
  - [ ] Handle submit on send button press
  - [ ] Clear input after send

- [ ] Implement typing indicator (AC: 5)
  - [ ] Create `TypingIndicator.tsx` component
  - [ ] Animated "..." dots (fade in/out animation)
  - [ ] Show when agent is processing

- [ ] Implement quick reply buttons (AC: 6)
  - [ ] Create `QuickReplyButtons.tsx` component
  - [ ] Horizontal scrollable row of buttons
  - [ ] Button press sends message automatically
  - [ ] Hide buttons after user selects one

- [ ] Add WebSocket integration
  - [ ] Connect to Modal WebSocket endpoint on component mount
  - [ ] Send user messages via WebSocket
  - [ ] Receive agent messages via WebSocket
  - [ ] Handle connection errors (show "Reconnecting..." message)

## Dev Notes

### Relevant Source Tree
- **Location:** `mindmirror-mobile/components/OnboardingChat.tsx`
- **Alternative:** Use `react-native-gifted-chat` library if time-constrained

### Key Technical Details
- React Native FlatList for message list (optimized for performance)
- WebSocket client: `socket.io-client` or native WebSocket API
- Typing animation: Use `react-native-reanimated` or `Animated` API
- Quick reply buttons: Horizontal `ScrollView` with buttons

### Implementation Notes
```typescript
// Example component structure
import React, { useState, useEffect } from 'react';
import { FlatList, View, TextInput, TouchableOpacity } from 'react-native';
import io from 'socket.io-client';

interface Message {
  id: string;
  role: 'agent' | 'user';
  content: string;
  timestamp: Date;
  quickReplies?: string[];
}

export const OnboardingChat = ({ userId }: { userId: string }) => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [socket, setSocket] = useState(null);

  useEffect(() => {
    const ws = io('wss://[modal-url]/chat/' + userId);
    setSocket(ws);

    ws.on('message', (data) => {
      setMessages(prev => [...prev, data]);
      setIsTyping(false);
    });

    ws.on('typing', () => setIsTyping(true));

    return () => ws.close();
  }, [userId]);

  const sendMessage = (text: string) => {
    if (!text.trim()) return;

    const message = { role: 'user', content: text };
    setMessages(prev => [...prev, message]);
    socket.emit('message', message);
    setInputText('');
    setIsTyping(true);
  };

  return (
    <View style={{ flex: 1 }}>
      <FlatList
        data={messages}
        renderItem={({ item }) => <MessageBubble message={item} />}
        keyExtractor={(item) => item.id}
      />
      {isTyping && <TypingIndicator />}
      <View style={{ flexDirection: 'row' }}>
        <TextInput
          value={inputText}
          onChangeText={setInputText}
          placeholder="Type a message..."
        />
        <TouchableOpacity onPress={() => sendMessage(inputText)}>
          <Text>Send</Text>
        </TouchableOpacity>
      </View>
    </View>
  );
};
```

### Testing
**Test file location:** `mindmirror-mobile/components/__tests__/OnboardingChat.test.tsx`

**Test standards:**
- Component rendering tests (Jest + React Native Testing Library)
- WebSocket integration test (mock WebSocket)
- User interaction tests (send message, tap quick reply)

**Testing frameworks:**
- Jest
- React Native Testing Library
- Mock WebSocket client

**Specific testing requirements:**
- Test message list renders correctly
- Test send button disabled when input empty
- Test quick reply button sends message
- Test typing indicator appears/disappears
- Test WebSocket connection/disconnection

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 8 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
