# Story 3.1: Cloud Run v2 Migration

## Status
Draft

## Story
**As a** platform engineer
**I want** production deployment to use `google_cloud_run_v2_service` (OpenTofu)
**So that** we leverage min instances (eliminate cold starts), startup CPU boost, and improved health checks

## Acceptance Criteria

1. **All services migrated to v2:** All 7 microservices (agent, journal, habits, meals, movements, practices, users) + gateway use `google_cloud_run_v2_service` resource in OpenTofu
2. **Min instances configured:** Critical services have `min_instances = 1`:
   - `users_service` (CRITICAL - entire system depends on it)
   - `gateway` (user-facing entry point)
   - `agent_service` (core AI functionality)
3. **Health checks configured:** Startup probes and liveness probes properly configured for each service
4. **Environment variables migrated:** All env vars and secrets configuration equivalent to current staging setup (v2 schema compatible)
5. **OpenTofu plan clean:** `tofu plan` shows expected resource changes only (no unnecessary recreation)
6. **Staging validated first:** Migration tested in staging environment before production deployment
7. **Service URLs updated:** Internal service discovery updated if v2 changes URL patterns

## Tasks / Subtasks

- [ ] **Update OpenTofu modules for Cloud Run v2** (AC: 1, 2, 3, 4)
  - [ ] Replace `google_cloud_run_service` with `google_cloud_run_v2_service` in all service modules
  - [ ] Update `infra/modules/agent/main.tf`
  - [ ] Update `infra/modules/journal/main.tf`
  - [ ] Update `infra/modules/habits/main.tf`
  - [ ] Update `infra/modules/meals/main.tf`
  - [ ] Update `infra/modules/movements/main.tf`
  - [ ] Update `infra/modules/practices/main.tf`
  - [ ] Update `infra/modules/users/main.tf`
  - [ ] Update `infra/modules/gateway/main.tf` (or equivalent)
  - [ ] Migrate environment variables to v2 schema (check resource docs for changes)
  - [ ] Migrate secrets configuration to v2 schema (volume mounts vs env vars)

- [ ] **Configure min instances for critical services** (AC: 2)
  - [ ] Set `min_instances = 1` for `users_service` (CRITICAL PATH)
  - [ ] Set `min_instances = 1` for `gateway` (user-facing)
  - [ ] Set `min_instances = 1` for `agent_service` (core functionality)
  - [ ] Document cost impact of min instances in runbook

- [ ] **Configure health checks** (AC: 3)
  - [ ] Add startup probe configuration (path: `/health`, initial_delay: 10s, timeout: 3s)
  - [ ] Add liveness probe configuration (path: `/health`, period: 30s, timeout: 3s)
  - [ ] Validate health check endpoints exist in all services

- [ ] **Test in staging environment** (AC: 6)
  - [ ] Run `tofu plan` for staging with v2 resources
  - [ ] Review plan output for unexpected changes
  - [ ] Backup staging OpenTofu state: `tofu state pull > backup-staging-$(date +%Y%m%d).json`
  - [ ] Apply to staging: `tofu apply`
  - [ ] Validate all services start successfully in staging
  - [ ] Test health check endpoints: `curl https://[service-url]/health`
  - [ ] Test end-to-end workflow in staging (signup → voucher → workout)

- [ ] **Validate OpenTofu plan for production** (AC: 5)
  - [ ] Run `tofu plan -var-file=env.production -out=production.tfplan`
  - [ ] Review plan for:
    - Expected: Cloud Run v2 resource creation
    - Unexpected: Database recreation, service deletion, etc.
  - [ ] Document any manual interventions needed

- [ ] **Update service discovery (if needed)** (AC: 7)
  - [ ] Check if Cloud Run v2 URL patterns differ from v1
  - [ ] Update gateway mesh configuration if internal URLs changed
  - [ ] Update any hardcoded service URLs in codebase

## Dev Notes

### Relevant Source Tree
- **OpenTofu Modules:** `infra/modules/*/main.tf` (all service modules)
- **Main Infra Config:** `infra/main.tf`
- **Environment Config:** `env.production`, `env.staging`

### Key Technical Details

**Cloud Run v1 vs v2 Differences:**
- **Resource name:** `google_cloud_run_service` → `google_cloud_run_v2_service`
- **Min instances:** v2 supports `min_instances` (v1 does not)
- **Startup CPU boost:** v2 automatically provides CPU boost during container startup
- **Health checks:** v2 has improved startup/liveness probe configuration
- **Schema changes:** Environment variables, secrets, and networking configuration syntax may differ

**Critical Services Requiring min_instances = 1:**
1. **users_service:** Entire system depends on it (auth ID exchange in gateway)
2. **gateway:** User-facing entry point (poor UX if cold start on first request)
3. **agent_service:** Core AI functionality (journaling, coaching)

**Cost Impact:**
- Min instances mean services always running (even at zero traffic)
- Estimated cost: ~$10-15/month per service with min_instances=1
- Total additional cost for 3 services: ~$30-45/month
- Within $100/month budget for alpha

### Implementation Notes

**OpenTofu State Management:**
- **CRITICAL:** Backup state before migration: `tofu state pull > backup-state-$(date +%Y%m%d).json`
- Use GCS backend for state (already configured)
- State versioning enabled (can rollback if needed)

**Resource Recreation vs. Update-in-Place:**
- Cloud Run v1 → v2 migration will likely **recreate** resources (not update in place)
- This causes brief downtime during `tofu apply`
- **Mitigation:** Run during low-traffic window (staging has minimal traffic)

**Health Check Endpoints:**
- Verify all services expose `/health` endpoint
- If missing, add health check endpoint before migration
- Health checks should return `200 OK` when service is ready

### Testing

**Test file location:** Infrastructure testing via OpenTofu plan/apply + manual validation

**Test standards:**
- OpenTofu plan shows only expected resource changes
- All services start successfully after migration
- Health checks return 200 OK
- End-to-end workflow completes successfully

**Testing frameworks:**
- OpenTofu (plan/apply validation)
- Manual curl commands to health endpoints
- Manual testing of voucher flow in staging

**Specific testing requirements:**

1. **OpenTofu Plan Validation:**
   ```bash
   # Staging
   cd infra
   tofu plan -var-file=env.staging -out=staging.tfplan
   # Review output carefully
   ```

2. **Health Check Validation (after deployment):**
   ```bash
   # Test each service health endpoint
   curl https://agent-service-staging-xyz.run.app/health
   curl https://journal-service-staging-xyz.run.app/health
   curl https://users-service-staging-xyz.run.app/health
   # ... (repeat for all services)
   ```

3. **End-to-End Workflow:**
   - Navigate to staging web app
   - Create test user account
   - Generate magic link voucher (admin panel)
   - Complete signup flow
   - Log sample workout
   - Verify workout appears in database

4. **Min Instances Validation:**
   - Check GCP Console → Cloud Run → Service Details
   - Verify `users_service`, `gateway`, `agent_service` show "Min instances: 1"
   - Verify services do not scale down to zero

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |
| 2025-10-18 | v2.0 | Complete rewrite: OpenTofu v2 migration with min instances, health checks, staging-first testing | Alex (DevOps Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
