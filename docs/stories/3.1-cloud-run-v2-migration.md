# Story 3.1: Cloud Run v2 Migration

## Status
Draft

## Story
**As a** platform engineer
**I want** production deployment to use google_cloud_run_v2_service module
**so that** we leverage latest GCP features (min instances, startup CPU boost, better logging)

## Acceptance Criteria

1. infra/modules/practices/main.tf uses `google_cloud_run_v2_service` resource (not v1)
2. All 7 services (agent, journal, habits, meals, movements, practices, users) + gateway migrated to v2
3. Environment variables and secrets configuration equivalent to current staging setup
4. Health checks configured with proper startup/liveness probes
5. Min instances set to 1 for practices_service (prevent cold starts during alpha)
6. Terraform plan shows clean migration (no resource recreation unless necessary)
7. Test migration in staging before applying to production

## Tasks / Subtasks

- [ ] Update practices_service Terraform module (AC: 1, 3, 4, 5)
  - [ ] Replace `google_cloud_run_service` with `google_cloud_run_v2_service` in `infra/modules/practices/main.tf`
  - [ ] Migrate environment variables to v2 format (check v2 resource schema)
  - [ ] Migrate secrets configuration to v2 format
  - [ ] Configure health checks (startup probe + liveness probe)
  - [ ] Set `min_instances = 1` for practices_service

- [ ] Update remaining 6 services + gateway (AC: 2)
  - [ ] Repeat v2 migration for: agent, journal, habits, meals, movements, users services
  - [ ] Migrate gateway to v2
  - [ ] Ensure consistent configuration across all services

- [ ] Test in staging environment (AC: 7)
  - [ ] Run `terraform plan` to review changes
  - [ ] Apply to staging environment first
  - [ ] Validate all services start successfully
  - [ ] Run health checks to ensure services respond
  - [ ] Test end-to-end workflows (signup, workout logging)

- [ ] Validate clean migration (AC: 6)
  - [ ] Review Terraform plan for unexpected resource recreation
  - [ ] Backup Terraform state before applying
  - [ ] Apply migration with `terraform apply`
  - [ ] Verify services are running in GCP Console

## Dev Notes

### Relevant Source Tree
- **Terraform Modules:** `infra/main.tf`, `infra/modules/practices/main.tf`, etc.
- **Services:** 7 microservices (agent, journal, habits, meals, movements, practices, users) + gateway
- **Secrets:** Google Secret Manager integration

### Key Technical Details
- Current deployment uses `google_cloud_run_service` (v1) resource
- Cloud Run v2 provides improved features:
  - Min instances (prevent cold starts)
  - Startup CPU boost (faster container initialization)
  - Better logging/monitoring
  - Improved health check configuration
- Resource schema differences between v1 and v2 (consult Terraform docs)

### Implementation Notes
- **Reference:** https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/cloud_run_v2_service
- Backup Terraform state file before migration
- Use Terraform Cloud or GCS backend for state versioning
- Test in isolated GCP project if possible before staging
- Consider using Terraform workspaces for environment separation

### CRITICAL MIGRATION STEPS
1. **Backup state:** `terraform state pull > backup-state-$(date +%Y%m%d).json`
2. **Plan in staging:** `terraform plan -var-file=env.staging`
3. **Apply to staging:** `terraform apply -var-file=env.staging`
4. **Validate staging:** Run health checks, test workflows
5. **Repeat for production:** Only after staging validation

### Testing
**Test file location:** Infrastructure testing via Terraform plan/apply

**Test standards:**
- Terraform plan shows expected resource changes only
- No unnecessary resource recreation
- All services start successfully after migration
- Health checks pass for all services

**Testing frameworks:**
- Terraform (plan/apply)
- Manual GCP Console verification
- curl commands to health check endpoints

**Specific testing requirements:**
- Run `terraform plan` and review output (no unexpected changes)
- Apply to staging environment first
- Test health endpoints: `curl http://[service-url]/health`
- Test end-to-end workflows (signup → voucher → workout)
- Verify min instances configuration in GCP Console (practices_service should show 1 min instance)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
