# Story 10.2: Workout Program Filtering

## Status
Draft

## Story
**As a** user
**I want** workout programs filtered by my training preferences
**so that** I only see relevant programs

## Acceptance Criteria

1. Programs list fetches user profile: `GET /users/{user_id}/profiles` (GraphQL query)
2. If `movement_profile.training_preferences` exists, filter programs:
   - User prefers "strength_training" → show strength-focused programs
   - User prefers "yoga" → show yoga/flexibility programs
   - User prefers "mixed" → show all programs
3. If profile incomplete, show all programs (no filtering)
4. Filter toggle: "Show all programs" checkbox (allows user to explore)

## Tasks / Subtasks

- [ ] Add GraphQL query for user profile (AC: 1)
  - [ ] Fetch user profile on programs list mount
  - [ ] Extract `movementProfile.trainingPreferences`

- [ ] Implement filtering logic (AC: 2, 3)
  - [ ] If `movementProfile === null`, show all programs (no filter)
  - [ ] If `trainingPreferences` includes "strength_training", filter programs with `category === "strength"`
  - [ ] If `trainingPreferences` includes "yoga", filter programs with `category === "yoga"`
  - [ ] If `trainingPreferences` includes "mixed", show all programs

- [ ] Add filter toggle (AC: 4)
  - [ ] Checkbox: "Show all programs" at top of list
  - [ ] Default: unchecked (filtering enabled)
  - [ ] When checked: show all programs regardless of preferences
  - [ ] Persist toggle state in AsyncStorage

- [ ] Update UI to show filter status
  - [ ] If filtering active, show banner: "Showing programs for: Strength Training" (with dismiss option)
  - [ ] If "Show all" enabled, banner hidden

## Dev Notes

### Relevant Source Tree
- **Location:** `mindmirror-mobile/app/(app)/programs/index.tsx`
- **GraphQL:** Reuse `GET_USER_PROFILE` query from Story 10.1

### Key Technical Details
- Programs data includes `category` field (strength, yoga, running, etc.)
- Filtering happens client-side (array.filter())
- AsyncStorage for toggle state persistence

### Implementation Notes
```typescript
// Programs list component
import { useQuery } from '@apollo/client';
import { GET_USER_PROFILE } from '@/graphql/queries';
import AsyncStorage from '@react-native-async-storage/async-storage';

export default function ProgramsList() {
  const [showAll, setShowAll] = useState(false);
  const { data: profileData } = useQuery(GET_USER_PROFILE);
  const { data: programsData } = useQuery(GET_PROGRAMS);

  useEffect(() => {
    const loadToggleState = async () => {
      const state = await AsyncStorage.getItem('show_all_programs');
      setShowAll(state === 'true');
    };
    loadToggleState();
  }, []);

  const handleToggle = async (value: boolean) => {
    setShowAll(value);
    await AsyncStorage.setItem('show_all_programs', value.toString());
  };

  const movementProfile = profileData?.userProfile?.movementProfile;
  const programs = programsData?.programs || [];

  const filteredPrograms = React.useMemo(() => {
    if (showAll || !movementProfile) {
      return programs;  // Show all if toggle enabled or profile incomplete
    }

    const preferences = movementProfile.trainingPreferences;

    if (preferences.includes('mixed')) {
      return programs;  // Mixed preference = show all
    }

    // Filter by training preferences
    return programs.filter(program =>
      preferences.some(pref => program.category.includes(pref))
    );
  }, [programs, movementProfile, showAll]);

  return (
    <View>
      <View style={styles.filterToggle}>
        <Checkbox
          value={showAll}
          onValueChange={handleToggle}
        />
        <Text>Show all programs</Text>
      </View>

      {!showAll && movementProfile && (
        <View style={styles.filterBanner}>
          <Text>Showing programs for: {movementProfile.trainingPreferences.join(', ')}</Text>
        </View>
      )}

      <FlatList
        data={filteredPrograms}
        renderItem={({ item }) => <ProgramCard program={item} />}
      />
    </View>
  );
}
```

### Testing
**Test file location:** `mindmirror-mobile/app/(app)/programs/__tests__/index.test.tsx`

**Test standards:**
- Component rendering tests with mock data
- Filtering logic tests (different training preferences)
- Toggle state persistence tests

**Testing frameworks:**
- Jest + React Native Testing Library
- Mock Apollo Client + AsyncStorage

**Specific testing requirements:**
- Test filtering: strength preference → only strength programs shown
- Test "Show all" toggle disables filtering
- Test incomplete profile → all programs shown
- Test toggle state persists across app restarts
- Test filter banner shows correct preferences

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 10 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
