# Story 6.2: Conversation State Management (Redis)

## Status
Draft

## Story
**As a** developer
**I want** conversation history stored in Redis with auto-expiration
**so that** users can resume conversations and we don't store data indefinitely

## Acceptance Criteria

1. Redis connection configured (use Upstash for serverless Redis)
2. Key pattern: `onboarding:{user_id}:conversation`
3. Value: JSON array of messages: `[{"role": "agent", "content": "What's your name?"}, {"role": "user", "content": "Alex"}]`
4. TTL: 7 days (auto-delete after 1 week)
5. Helper functions: `save_message(user_id, role, content)`, `get_conversation(user_id)`, `clear_conversation(user_id)`

## Tasks / Subtasks

- [ ] Set up Upstash Redis (AC: 1)
  - [ ] Create Upstash account (free tier)
  - [ ] Create Redis database (select region closest to Modal deployment)
  - [ ] Copy connection string (REDIS_URL)
  - [ ] Add to Modal secrets

- [ ] Implement Redis client wrapper (AC: 2, 3, 4, 5)
  - [ ] Create `redis_client.py` with connection logic
  - [ ] Implement `save_message(user_id: str, role: str, content: str)` function
  - [ ] Implement `get_conversation(user_id: str) -> List[Dict]` function
  - [ ] Implement `clear_conversation(user_id: str)` function
  - [ ] Set TTL to 7 days (604800 seconds) on key creation

- [ ] Integrate with conversation flow (AC: 2, 3)
  - [ ] Call `save_message()` after each agent/user message
  - [ ] Call `get_conversation()` when user resumes chat
  - [ ] Call `clear_conversation()` after successful profile extraction

- [ ] Add error handling
  - [ ] Graceful degradation if Redis unavailable (conversation still works, just can't resume)
  - [ ] Retry logic for connection failures (3 retries with exponential backoff)
  - [ ] Log errors to Logfire

## Dev Notes

### Relevant Source Tree
- **Location:** `onboarding-agent/redis_client.py`
- **Upstash Docs:** https://upstash.com/docs/redis/overall/getstarted
- **Redis Client:** Use `redis-py` library

### Key Technical Details
- Upstash Redis is serverless (no infra management, pay-per-request)
- Free tier: 10,000 commands/day (sufficient for alpha)
- Connection pooling handled by `redis-py`
- TTL automatically deletes keys after expiration

### Implementation Notes
```python
# Example Redis client wrapper
import redis
import json
from typing import List, Dict
import os

redis_client = redis.from_url(os.getenv("REDIS_URL"))

def save_message(user_id: str, role: str, content: str):
    """Save message to conversation history"""
    key = f"onboarding:{user_id}:conversation"
    message = {"role": role, "content": content}

    # Get existing conversation or create new list
    existing = redis_client.get(key)
    messages = json.loads(existing) if existing else []

    # Append new message
    messages.append(message)

    # Save with 7-day TTL
    redis_client.setex(key, 604800, json.dumps(messages))

def get_conversation(user_id: str) -> List[Dict]:
    """Retrieve conversation history"""
    key = f"onboarding:{user_id}:conversation"
    data = redis_client.get(key)
    return json.loads(data) if data else []

def clear_conversation(user_id: str):
    """Delete conversation history"""
    key = f"onboarding:{user_id}:conversation"
    redis_client.delete(key)
```

### Testing
**Test file location:** `onboarding-agent/tests/test_redis_client.py`

**Test standards:**
- Unit tests with mock Redis client
- Integration test with real Upstash instance
- TTL validation (check key expires after 7 days)

**Testing frameworks:**
- pytest
- `fakeredis` for mocking
- `redis-py` for integration tests

**Specific testing requirements:**
- Test `save_message()` appends to existing conversation
- Test `get_conversation()` returns correct message order
- Test `clear_conversation()` deletes key
- Test TTL is set correctly (7 days)
- Test graceful degradation if Redis unavailable

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 6 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
