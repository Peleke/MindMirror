# Story 3.4b: Client x-internal-id Removal (Phased Cutover)

## Status
Draft - **DEFERRED** (complete after Story 3.4a proven stable in production)

## Story
**As a** security engineer
**I want** to remove `x-internal-id` from client requests after 3.4a is validated
**So that** we complete the auth security hardening with zero client-side trust

## Acceptance Criteria

1. **Client code updated:** Web and mobile apps stop sending `x-internal-id` header in requests
2. **Gateway validation:** Gateway rejects requests if client sends `x-internal-id` (log warning, strip header)
3. **Backward compatibility removed:** Gateway no longer logs mismatches (dual-mode disabled)
4. **End-to-end testing:** All user flows work without client `x-internal-id` header
5. **Production validation:** Story 3.4a deployed and stable for at least 24 hours before client changes deployed

## Tasks / Subtasks

- [ ] **Wait for Story 3.4a stability** (AC: 5)
  - [ ] Story 3.4a deployed to production
  - [ ] Gateway auth (JWT → users_service → Redis) working correctly
  - [ ] No auth errors in production logs for 24+ hours
  - [ ] Cache hit rate >90% (Redis caching working)

- [ ] **Update web client** (AC: 1)
  - [ ] Remove `x-internal-id` header from Apollo Client requests:
    ```typescript
    // Before (INSECURE):
    const headers = {
      'Authorization': `Bearer ${token}`,
      'x-internal-id': userId,  // ❌ REMOVE THIS
    };

    // After (SECURE):
    const headers = {
      'Authorization': `Bearer ${token}`,
      // Gateway will add x-internal-id after validating JWT
    };
    ```
  - [ ] Update `web/src/lib/apollo-client.ts` or equivalent
  - [ ] Test locally: Verify requests succeed without header

- [ ] **Update mobile client** (AC: 1)
  - [ ] Remove `x-internal-id` from Apollo Client headers:
    ```typescript
    // mindmirror-mobile/src/lib/apollo-client.ts
    const headers = {
      'Authorization': `Bearer ${token}`,
      // Remove x-internal-id
    };
    ```
  - [ ] Test locally: Verify requests succeed without header
  - [ ] Test on physical device (not just simulator)

- [ ] **Update gateway validation** (AC: 2, 3)
  - [ ] Remove backward compatibility code from Story 3.4a:
    ```typescript
    // Remove this logging code:
    if (req.headers['x-internal-id'] && req.headers['x-internal-id'] !== internalId) {
      console.warn(`Client x-internal-id mismatch...`);
    }
    ```
  - [ ] Add explicit rejection if client sends header:
    ```typescript
    if (req.headers['x-internal-id']) {
      console.warn('Client sent x-internal-id header (deprecated), stripping');
      delete req.headers['x-internal-id'];  // Strip client header
    }
    ```
  - [ ] Gateway always sets `x-internal-id` from validated JWT (no client input)

- [ ] **Test end-to-end** (AC: 4)
  - [ ] Test web app: Signup → voucher → workout (no client header)
  - [ ] Test mobile app: Signup → voucher → workout (no client header)
  - [ ] Test API directly: GraphQL queries with just Authorization header
  - [ ] Verify gateway logs show no warnings about client headers

## Dev Notes

### Relevant Source Tree
- **Web Client:** `web/src/lib/apollo-client.ts` (or wherever Apollo is configured)
- **Mobile Client:** `mindmirror-mobile/src/lib/apollo-client.ts`
- **Gateway:** `mesh/gateway.config.ts` or gateway middleware code

### Key Technical Details

**Why Phased Cutover:**
- Story 3.4a introduces new gateway auth logic (high risk)
- If 3.4a has bugs, we can hotfix WITHOUT client changes
- Separating client changes (3.4b) reduces blast radius
- 24-hour stability window ensures 3.4a is production-ready

**Risk Mitigation:**
- If 3.4b client changes cause issues, we can rollback client only (gateway still works)
- Gateway dual-mode (3.4a) acts as safety net during transition

**Deployment Order:**
1. Deploy Story 3.4a (gateway changes) - FIRST
2. Validate 24+ hours in production - SECOND
3. Deploy Story 3.4b (client changes) - THIRD

### Implementation Notes

**Client Testing:**
- Test without `x-internal-id` header locally before deploying
- Use browser DevTools Network tab to verify header not sent
- Mobile: Use Charles Proxy or similar to inspect requests

**Gateway Behavior After 3.4b:**
- Clients no longer send `x-internal-id`
- Gateway parses JWT, queries users_service, sets `x-internal-id`
- Mesh services receive `x-internal-id` from gateway (trusted source)

**Rollback Plan:**
- If clients break after 3.4b, rollback client code (re-add header)
- Gateway in 3.4a state still accepts both modes (backward compatible)

### Security Considerations

**Complete Security Model (After 3.4b):**
```
Client → Gateway (validates JWT → queries users_service → caches → forwards ID)
           ↓
         Mesh (trusts x-internal-id from gateway only)
```

**Attack Vectors Eliminated:**
- Client cannot spoof user identity (no `x-internal-id` accepted from client)
- JWT must be valid and signed by Supabase (gateway verifies signature)
- Internal ID comes from authoritative source (users_service)

### Testing

**Test file location:** Web and mobile client testing + gateway integration tests

**Test standards:**
- Clients successfully make requests without `x-internal-id` header
- Gateway correctly validates JWT and queries users_service
- End-to-end workflows complete successfully

**Testing frameworks:**
- Browser DevTools for web client
- Charles Proxy or Network Link Conditioner for mobile
- Manual testing of user flows

**Specific testing requirements:**

1. **Web Client Test:**
   ```bash
   # Run web app locally
   cd web && npm run dev

   # Open browser DevTools → Network tab
   # Make authenticated request (e.g., load dashboard)
   # Inspect request headers: Should NOT contain x-internal-id
   # Request should succeed (gateway adds header)
   ```

2. **Mobile Client Test:**
   ```bash
   # Run mobile app on device
   cd mindmirror-mobile && npm start

   # Use Charles Proxy to inspect network traffic
   # Filter for GraphQL requests to gateway
   # Verify: Authorization header present, x-internal-id absent
   # Request should succeed
   ```

3. **Gateway Validation Test:**
   ```bash
   # Attempt to send x-internal-id from curl (simulate malicious client)
   curl -X POST https://gateway-prod-xyz.a.run.app/graphql \
     -H "Authorization: Bearer $VALID_TOKEN" \
     -H "x-internal-id: 999" \
     -d '{"query": "{ __typename }"}'

   # Check gateway logs: Should show warning about deprecated header
   # Response should succeed (gateway stripped client header, used validated ID)
   ```

4. **End-to-End Workflow Test:**
   - **Web:** Navigate to app, log in, create workout entry → Verify success
   - **Mobile:** Open app, log in, log workout → Verify success
   - **Check Database:** Verify workout entry associated with correct user (not spoofed)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-18 | v1.0 | New story: Remove client x-internal-id header after 3.4a proven stable (phased cutover) | Alex (DevOps Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
