# Story 3.3: Infrastructure Bootstrapping Automation

## Status
Draft

## Story
**As a** platform engineer
**I want** one-command deployment that provisions all GCP + Supabase resources
**so that** disaster recovery or new environment setup takes minutes, not hours

## Acceptance Criteria

1. `make production-deploy` command runs: Terraform init → plan → apply → Supabase migrations
2. Script validates prerequisites: gcloud auth, Terraform installed, Supabase CLI configured
3. Idempotent: Running twice doesn't break existing resources
4. Outputs critical values: Gateway URL, Database connection strings, Supabase project URL
5. Rollback mechanism: `make production-rollback` reverts to previous Terraform state
6. Documentation: Runbook at `docs/infrastructure/production-deployment.md`

## Tasks / Subtasks

- [ ] Create `make production-deploy` command (AC: 1, 2, 3)
  - [ ] Add target to Makefile
  - [ ] Run prerequisite checks (gcloud auth, Terraform, Supabase CLI)
  - [ ] Run Terraform init, plan, apply with production variables
  - [ ] Run Supabase migrations (`supabase db push`)
  - [ ] Make script idempotent (check if resources exist before creating)

- [ ] Output deployment info (AC: 4)
  - [ ] Capture Terraform outputs (Gateway URL, service URLs)
  - [ ] Display Supabase project URL and credentials location
  - [ ] Save outputs to file (e.g., `production-outputs.txt`)

- [ ] Create rollback mechanism (AC: 5)
  - [ ] Add `make production-rollback` target to Makefile
  - [ ] Backup Terraform state before each deployment
  - [ ] Implement state restore from backup
  - [ ] Test rollback in staging environment first

- [ ] Write deployment runbook (AC: 6)
  - [ ] Create `docs/infrastructure/production-deployment.md`
  - [ ] Document prerequisites, step-by-step deployment process
  - [ ] Document rollback procedure
  - [ ] Include troubleshooting section

## Dev Notes

### Relevant Source Tree
- **Makefile:** Root `Makefile` (extend with new targets)
- **Terraform:** `infra/` directory
- **Supabase Migrations:** `src/alembic-config/` and Supabase-specific migrations
- **Documentation:** `docs/infrastructure/` (create new directory)

### Key Technical Details
- Makefile targets should be simple wrappers around Terraform and Supabase CLI
- Prerequisites validation prevents failed deployments mid-way
- Idempotency ensures safe re-runs (Terraform handles this naturally)
- Terraform outputs provide critical post-deployment information
- State backups enable disaster recovery

### Implementation Notes
- Use `terraform workspace` for environment separation (staging, production)
- Terraform state should be stored in GCS backend (not local)
- Supabase migrations should be version-controlled SQL files
- Consider using `set -e` in bash scripts to fail fast on errors

### DEPLOYMENT WORKFLOW
```bash
# Example implementation
make production-deploy:
  1. Check prerequisites (gcloud, terraform, supabase)
  2. Backup Terraform state
  3. terraform init -backend-config=env.production
  4. terraform plan -var-file=env.production -out=plan.tfplan
  5. terraform apply plan.tfplan
  6. supabase db push --project-ref production
  7. Display outputs (URLs, credentials location)
```

### ROLLBACK WORKFLOW
```bash
# Example implementation
make production-rollback:
  1. List available state backups
  2. Prompt user to select backup version
  3. terraform state restore <backup-file>
  4. terraform apply (revert to previous state)
```

### Testing
**Test file location:** Manual testing of deployment scripts

**Test standards:**
- Test `make production-deploy` in staging environment first
- Validate idempotency (run twice, ensure no errors)
- Test rollback mechanism (deploy → rollback → verify state)

**Testing frameworks:**
- Manual bash script testing
- Terraform plan validation
- GCP Console verification

**Specific testing requirements:**
- Test prerequisite checks catch missing tools
- Test deployment completes successfully
- Test idempotency: Run deployment twice (second run should be no-op)
- Test outputs are displayed and saved
- Test rollback: Deploy → Rollback → Verify resources reverted

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
