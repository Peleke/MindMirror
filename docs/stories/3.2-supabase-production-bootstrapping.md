# Story 3.2: Supabase Production Bootstrapping

## Status
Draft

## Story
**As a** platform engineer
**I want** dedicated Supabase production project with documented setup process (manual + scripts OK)
**So that** alpha user data is isolated with RLS policies, 24h JWT expiry, and email confirmation

## Acceptance Criteria

1. **Production Supabase project created:** New project separate from staging (manual creation via Supabase Dashboard acceptable)
2. **Credentials stored securely:** `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` stored in Google Secret Manager
3. **RLS policies enabled:** Row-Level Security enabled on `vouchers` table (and any other user-specific tables)
4. **JWT expiry configured:** JWT tokens expire after 24 hours (vs 7 days in staging)
5. **Email confirmation required:** Users must confirm email before account activation
6. **Database schema applied:** All necessary tables, indexes, and policies created via migrations
7. **Runbook documentation:** Comprehensive step-by-step documentation in `docs/infrastructure/supabase-production-setup.md`
8. **Script automation where possible:** Idempotent scripts for migrations, RLS policies, and configuration (manual steps documented for UI-only settings)

## Tasks / Subtasks

- [ ] **Create production Supabase project** (AC: 1)
  - [ ] Navigate to Supabase Dashboard (https://app.supabase.com)
  - [ ] Create new project: `mindmirror-production` (or similar naming)
  - [ ] Select region: `us-east-1` (or closest to GCP region for latency)
  - [ ] Note down project reference ID
  - [ ] Save project URL, anon key, service role key (will store in Secret Manager)

- [ ] **Store credentials in Secret Manager** (AC: 2)
  - [ ] Create secret: `production-supabase-url` with project URL
  - [ ] Create secret: `production-supabase-anon-key` with anon key
  - [ ] Create secret: `production-supabase-service-role-key` with service role key (HIGHLY SENSITIVE)
  - [ ] Grant Secret Accessor IAM role to Cloud Run service accounts
  - [ ] Update OpenTofu to reference secrets (not hardcoded values)

- [ ] **Configure authentication settings** (AC: 4, 5)
  - [ ] Supabase Dashboard → Authentication → Settings
  - [ ] Set JWT expiry: 24 hours (3600 * 24 = 86400 seconds)
  - [ ] Enable "Email Confirmations" (require users to verify email)
  - [ ] Configure email templates (signup confirmation, password reset)
  - [ ] Test email delivery (send test confirmation email)

- [ ] **Apply database schema migrations** (AC: 6)
  - [ ] Run Alembic migrations for main database:
    ```bash
    cd src/alembic-config
    DATAB ASE_URL="postgresql://[supabase-connection-string]" alembic upgrade head
    ```
  - [ ] Run migrations for separate databases (habits, movements, practices, users):
    ```bash
    cd habits_service/alembic && alembic upgrade head
    cd movements_service/alembic && alembic upgrade head
    cd practices_service/alembic && alembic upgrade head
    cd users_service/alembic && alembic upgrade head
    ```
  - [ ] Verify tables created: Check Supabase Dashboard → Table Editor

- [ ] **Enable RLS policies** (AC: 3)
  - [ ] Create RLS policy for vouchers table:
    ```sql
    ALTER TABLE vouchers ENABLE ROW LEVEL SECURITY;

    -- Policy: Users can only read their own vouchers
    CREATE POLICY "Users can view their own vouchers" ON vouchers
      FOR SELECT
      USING (auth.uid() = user_id);

    -- Policy: Service role can create/update all vouchers (for admin magic link generation)
    CREATE POLICY "Service role can manage all vouchers" ON vouchers
      FOR ALL
      USING (auth.jwt() ->> 'role' = 'service_role');
    ```
  - [ ] Test RLS policies:
    - Create test user
    - Create voucher for user A
    - Attempt to query voucher as user B (should fail)
    - Query voucher as user A (should succeed)

- [ ] **Create setup scripts** (AC: 8)
  - [ ] Create `scripts/supabase-production-setup.sh`:
    - Idempotent RLS policy creation (check if exists before creating)
    - Schema validation (verify expected tables exist)
    - Configuration validation (JWT expiry, email confirmation)
  - [ ] Create SQL migration files for RLS policies in `src/alembic-config/versions/`
  - [ ] Test script idempotency (run twice, should not error)

- [ ] **Write runbook documentation** (AC: 7)
  - [ ] Create `docs/infrastructure/supabase-production-setup.md`
  - [ ] Document prerequisites (Supabase account, gcloud CLI, database credentials)
  - [ ] Step-by-step manual setup (project creation, auth config)
  - [ ] Step-by-step automated setup (running scripts, migrations)
  - [ ] Troubleshooting section (common errors, how to fix)
  - [ ] Emergency procedures (disable RLS, rollback migrations)

- [ ] **Validate end-to-end** (AC: all)
  - [ ] Test signup flow: Create new user, verify email confirmation required
  - [ ] Test JWT expiry: Log in, wait 24+ hours, verify token expires (forces re-login)
  - [ ] Test RLS policies: Verify users cannot access other users' vouchers
  - [ ] Test service role access: Verify admin can create vouchers for any user

## Dev Notes

### Relevant Source Tree
- **Alembic Migrations:** `src/alembic-config/versions/`, `habits_service/alembic/versions/`, etc.
- **Scripts:** `scripts/supabase-production-setup.sh` (to be created)
- **Documentation:** `docs/infrastructure/supabase-production-setup.md` (to be created)
- **OpenTofu:** `infra/` (update to reference production Supabase credentials from Secret Manager)

### Key Technical Details

**Supabase Project Setup:**
- **Region selection:** Choose region closest to GCP Cloud Run deployment (minimize latency)
- **Connection pooling:** Supabase provides connection pooling by default (important for Cloud Run serverless)
- **Database URL format:** `postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres`

**RLS (Row-Level Security):**
- **What it does:** Enforces data access control at the PostgreSQL level (not application level)
- **Why it matters:** Even if application has bug, database prevents unauthorized access
- **How it works:** Policies use `auth.uid()` to identify current user from Supabase JWT

**JWT Expiry:**
- **Staging:** 7 days (604800 seconds) - convenient for testing
- **Production:** 24 hours (86400 seconds) - more secure (limits token compromise window)
- **Impact:** Users must re-authenticate after 24 hours (acceptable for alpha)

**Email Confirmation:**
- **Purpose:** Prevents account creation with typo'd emails (security + UX)
- **Flow:** User signs up → receives confirmation email → clicks link → account activated
- **Testing:** Use real email address or Supabase test email feature

### Implementation Notes

**Manual vs. Automated Setup:**
- **Manual (via Supabase Dashboard):**
  - Project creation (no CLI support for this)
  - Auth configuration (JWT expiry, email confirmation)
  - Email template customization
- **Automated (via scripts/migrations):**
  - Database schema (Alembic migrations)
  - RLS policies (SQL scripts)
  - Validation checks (bash scripts)

**Supabase CLI Usage:**
- **Install:** `npm install -g supabase`
- **Link project:** `supabase link --project-ref [project-ref]`
- **Run migrations:** `supabase db push` (alternative to Alembic)
- **Note:** Alembic preferred for consistency with existing codebase

**Secret Manager Integration:**
- Store credentials in Secret Manager (not env files)
- OpenTofu modules reference secrets via `google_secret_manager_secret_version` data source
- Cloud Run services mount secrets as volumes (more secure than env vars)

### Security Considerations

**Service Role Key Protection:**
- **CRITICAL:** `SUPABASE_SERVICE_ROLE_KEY` bypasses RLS policies (full database access)
- **Storage:** Store only in Secret Manager (never commit to git, never log)
- **Access:** Only admin services should have access (not user-facing services)
- **Rotation:** Rotate periodically (Supabase Dashboard → Settings → API → Reset service role key)

**RLS Policy Testing:**
- **Test positive case:** Authorized user can access their own data
- **Test negative case:** Unauthorized user cannot access others' data
- **Test edge cases:** Empty user_id, null auth.uid(), service role bypass

**Database Connection Security:**
- Use SSL/TLS for all connections (Supabase enforces this by default)
- Never expose database password in logs or error messages
- Use connection pooling to prevent connection exhaustion

### Testing

**Test file location:** Manual testing + SQL queries + bash script validation

**Test standards:**
- All database tables exist and have correct schema
- RLS policies enforced correctly (users cannot access others' data)
- Auth configuration works (JWT expiry, email confirmation)
- Scripts are idempotent (running twice doesn't break anything)

**Testing frameworks:**
- Manual Supabase Dashboard testing
- SQL queries to validate RLS policies
- Bash scripts for automation validation
- curl commands to test auth endpoints

**Specific testing requirements:**

1. **RLS Policy Test (SQL):**
   ```sql
   -- As user A (user_id = '123')
   SET request.jwt.claims = '{"sub": "123"}';
   SELECT * FROM vouchers WHERE user_id = '123'; -- Should succeed
   SELECT * FROM vouchers WHERE user_id = '456'; -- Should return empty (RLS blocks)
   ```

2. **JWT Expiry Test:**
   ```bash
   # Log in and note JWT token
   # Wait 24+ hours
   # Attempt to use token (should receive 401 Unauthorized)
   curl -H "Authorization: Bearer [expired-token]" https://gateway-url/graphql
   ```

3. **Email Confirmation Test:**
   - Create new user via signup form
   - Check email inbox for confirmation link
   - Attempt to log in BEFORE clicking confirmation (should fail)
   - Click confirmation link
   - Attempt to log in AFTER confirmation (should succeed)

4. **Script Idempotency Test:**
   ```bash
   # Run setup script first time
   ./scripts/supabase-production-setup.sh
   # Run again (should not error, should report "already configured")
   ./scripts/supabase-production-setup.sh
   ```

5. **Service Role Test:**
   ```bash
   # Using service role key, create voucher for any user (should succeed)
   curl -X POST https://[supabase-url]/rest/v1/vouchers \
     -H "apikey: [service-role-key]" \
     -H "Authorization: Bearer [service-role-key]" \
     -d '{"user_id": "any-user-id", "code": "TEST123"}'
   ```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |
| 2025-10-18 | v2.0 | Complete rewrite: Production Supabase setup with RLS, JWT 24h expiry, email confirmation, runbook documentation, automated scripts | Alex (DevOps Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
