# Story 7.1: users_service GraphQL API Extensions

## Status
Draft

## Story
**As a** backend engineer
**I want** users_service to orchestrate profile creation/retrieval across services
**so that** frontend has single API for all profile operations

## Acceptance Criteria

1. GraphQL mutation `createUserProfile($input: UserProfileInput!)` creates user profile and delegates sub-profile creation
2. GraphQL mutation `updateOnboardingStatus($userId: ID!, $status: String!)` updates onboarding completion status
3. GraphQL query `userProfile($userId: ID!)` returns aggregated profile from all services
4. users_service makes REST calls to meals_service (`POST /eating-profiles`) and movements_service (`POST /movement-profiles`)
5. Handles partial profiles gracefully (nulls for missing fields, no errors)

## Tasks / Subtasks

- [ ] Define GraphQL schema extensions (AC: 1, 2, 3)
  - [ ] Add `UserProfileInput` input type (name, eating_profile, movement_profile)
  - [ ] Add `createUserProfile` mutation
  - [ ] Add `updateOnboardingStatus` mutation
  - [ ] Add `userProfile` query with nested eating/movement profiles
  - [ ] Add `UserProfile`, `EatingProfile`, `MovementProfile` types

- [ ] Implement `createUserProfile` resolver (AC: 1, 4)
  - [ ] Create `user_profiles` table record (name, user_id, onboarding_status)
  - [ ] Make REST POST to meals_service: `/eating-profiles` with eating_profile data
  - [ ] Make REST POST to movements_service: `/movement-profiles` with movement_profile data
  - [ ] Handle partial data (skip null fields)
  - [ ] Return created profile

- [ ] Implement `userProfile` query resolver (AC: 3, 4)
  - [ ] Fetch `user_profiles` record from local DB
  - [ ] Make REST GET to meals_service: `/eating-profiles/{user_id}`
  - [ ] Make REST GET to movements_service: `/movement-profiles/{user_id}`
  - [ ] Aggregate results into single `UserProfile` response
  - [ ] Handle missing sub-profiles (return null for eating/movement if not found)

- [ ] Implement `updateOnboardingStatus` resolver (AC: 2)
  - [ ] Update `user_profiles.onboarding_status` field
  - [ ] Return updated profile

- [ ] Add error handling
  - [ ] Retry logic for REST calls (3 retries with exponential backoff)
  - [ ] Rollback if sub-profile creation fails (delete user_profile record)
  - [ ] Log errors to standard output

## Dev Notes

### Relevant Source Tree
- **Location:** `users_service/app/graphql/schema.graphql`
- **Resolvers:** `users_service/app/graphql/resolvers/profile_resolvers.py`
- **REST Client:** `users_service/app/clients/` (for meals/movements service calls)

### Key Technical Details
- users_service uses Strawberry GraphQL (existing)
- REST calls to other services use `httpx` async client
- Database: PostgreSQL on port 5437 (separate from main DB)
- Alembic migration needed for `user_profiles` table

### Implementation Notes
```python
# GraphQL Schema
type UserProfile {
  id: ID!
  userId: ID!
  name: String!
  onboardingStatus: String!
  eatingProfile: EatingProfile
  movementProfile: MovementProfile
}

type EatingProfile {
  weight: Float!
  weightUnit: String!
  height: Float!
  heightUnit: String!
  eatingPreference: String!
  calorieTarget: Int!
  macroSplit: JSON!
}

type MovementProfile {
  trainingPreferences: [String!]!
  goals: [String!]!
}

input UserProfileInput {
  name: String!
  eatingProfile: EatingProfileInput
  movementProfile: MovementProfileInput
}

input EatingProfileInput {
  weight: Float!
  weightUnit: String!
  height: Float!
  heightUnit: String!
  eatingPreference: String!
}

input MovementProfileInput {
  trainingPreferences: [String!]!
  goals: [String!]!
}

type Mutation {
  createUserProfile(input: UserProfileInput!): UserProfile!
  updateOnboardingStatus(userId: ID!, status: String!): UserProfile!
}

type Query {
  userProfile(userId: ID!): UserProfile
}
```

### Testing
**Test file location:** `users_service/tests/test_profile_resolvers.py`

**Test standards:**
- Unit tests with mocked REST clients
- Integration test with real meals/movements services (local Docker)
- GraphQL query/mutation tests via Apollo Client

**Testing frameworks:**
- pytest
- pytest-asyncio for async tests
- `httpx-mock` for REST client mocking

**Specific testing requirements:**
- Test `createUserProfile` creates all sub-profiles
- Test partial profile creation (eating only, no movement)
- Test `userProfile` query aggregates data correctly
- Test error handling (meals_service unavailable)
- Test rollback on failure

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 7 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
