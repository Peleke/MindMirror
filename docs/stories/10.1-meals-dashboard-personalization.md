# Story 10.1: Meals Dashboard Personalization

## Status
Draft

## Story
**As a** user
**I want** my daily calorie target displayed on meals dashboard
**so that** I know how much I should eat

## Acceptance Criteria

1. Meals dashboard fetches user profile: `GET /users/{user_id}/profiles` (GraphQL query)
2. If `eating_profile.calorie_target` exists, display: "Daily goal: [target] cal"
3. If `eating_profile.macro_split` exists, show progress bar with protein/carbs/fat breakdown
4. If profile incomplete, show: "Complete your profile to see personalized targets" + "Set up now" CTA
5. Updates in real-time when profile completed (refetch on screen focus)

## Tasks / Subtasks

- [ ] Add GraphQL query for user profile (AC: 1)
  - [ ] Define `GET_USER_PROFILE` query in `graphql/queries.ts`
  - [ ] Fetch user profile on meals dashboard mount
  - [ ] Use Apollo Client `useQuery` hook

- [ ] Display calorie target (AC: 2)
  - [ ] Check if `eatingProfile.calorieTarget` exists
  - [ ] Render: "Daily goal: 2,200 cal" (large, bold text)
  - [ ] Show as card at top of dashboard

- [ ] Display macro progress bar (AC: 3)
  - [ ] Check if `eatingProfile.macroSplit` exists
  - [ ] Render horizontal progress bar with 3 segments: Protein (40%), Carbs (30%), Fat (30%)
  - [ ] Use brand colors for each macro (blue=protein, green=carbs, orange=fat)
  - [ ] Show labels: "Protein: 40% | Carbs: 30% | Fat: 30%"

- [ ] Handle incomplete profile (AC: 4)
  - [ ] If `eatingProfile === null`, show placeholder card
  - [ ] Text: "Complete your profile to see personalized targets"
  - [ ] CTA button: "Set up now" â†’ navigates to `/onboarding/launch`

- [ ] Add real-time updates (AC: 5)
  - [ ] Use `useFocusEffect` to refetch profile when screen focused
  - [ ] Show loading skeleton while fetching
  - [ ] Animate transition when profile data appears

## Dev Notes

### Relevant Source Tree
- **Location:** `mindmirror-mobile/app/(app)/meals/dashboard.tsx`
- **GraphQL:** `mindmirror-mobile/graphql/queries/user-profile.ts`

### Key Technical Details
- Apollo Client for GraphQL queries (existing)
- Expo Router `useFocusEffect` for refetch on screen focus
- React Native progress bar component or custom implementation

### Implementation Notes
```typescript
// GraphQL query
import { gql } from '@apollo/client';

export const GET_USER_PROFILE = gql`
  query GetUserProfile($userId: ID!) {
    userProfile(userId: $userId) {
      id
      name
      onboardingStatus
      eatingProfile {
        calorieTarget
        macroSplit
      }
    }
  }
`;

// Meals dashboard component
import { useQuery } from '@apollo/client';
import { useFocusEffect } from '@react-navigation/native';

export default function MealsDashboard() {
  const { data, loading, refetch } = useQuery(GET_USER_PROFILE, {
    variables: { userId: currentUserId }
  });

  useFocusEffect(() => {
    refetch();
  });

  if (loading) return <SkeletonLoader />;

  const profile = data?.userProfile;
  const eatingProfile = profile?.eatingProfile;

  if (!eatingProfile) {
    return (
      <View style={styles.placeholderCard}>
        <Text>Complete your profile to see personalized targets</Text>
        <TouchableOpacity onPress={() => router.push('/(onboarding)/launch')}>
          <Text>Set up now</Text>
        </TouchableOpacity>
      </View>
    );
  }

  return (
    <View>
      <View style={styles.calorieCard}>
        <Text style={styles.headline}>Daily goal: {eatingProfile.calorieTarget} cal</Text>
      </View>

      <View style={styles.macroBar}>
        <View style={[styles.macroSegment, { flex: eatingProfile.macroSplit.protein }]}>
          <Text>Protein: {eatingProfile.macroSplit.protein}%</Text>
        </View>
        <View style={[styles.macroSegment, { flex: eatingProfile.macroSplit.carbs }]}>
          <Text>Carbs: {eatingProfile.macroSplit.carbs}%</Text>
        </View>
        <View style={[styles.macroSegment, { flex: eatingProfile.macroSplit.fat }]}>
          <Text>Fat: {eatingProfile.macroSplit.fat}%</Text>
        </View>
      </View>
    </View>
  );
}
```

### Testing
**Test file location:** `mindmirror-mobile/app/(app)/meals/__tests__/dashboard.test.tsx`

**Test standards:**
- Component rendering tests with mock GraphQL data
- Test incomplete profile state (placeholder shown)
- Test complete profile state (calorie + macros shown)

**Testing frameworks:**
- Jest + React Native Testing Library
- Mock Apollo Client

**Specific testing requirements:**
- Test calorie target displays correctly (2,200 cal)
- Test macro progress bar renders 3 segments
- Test placeholder shown when profile incomplete
- Test "Set up now" button navigates to onboarding
- Test refetch on screen focus

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 10 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
