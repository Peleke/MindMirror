# Story 7.2: meals_service Eating Profile Storage

## Status
Draft

## Story
**As a** backend engineer
**I want** meals_service to store and serve eating profiles
**so that** eating preferences and calorie targets are managed in the appropriate domain service

## Acceptance Criteria

1. New table `eating_profiles` with fields: id, user_id, weight, weight_unit, height, height_unit, eating_preference, calorie_target, macro_split, created_at, updated_at
2. REST endpoints: `POST /eating-profiles` (create), `GET /eating-profiles/{user_id}` (read), `PUT /eating-profiles/{user_id}` (update)
3. Calorie target calculation using Harris-Benedict equation (BMR × activity multiplier)
4. Macro split defaults based on goals: Build muscle (40/30/30), Lose fat (35/35/30), General health (30/40/30)

## Tasks / Subtasks

- [ ] Create Alembic migration for `eating_profiles` table (AC: 1)
  - [ ] Add table with all required columns
  - [ ] Add foreign key constraint to user_id (or just index, since Supabase auth users are in separate DB)
  - [ ] Add unique constraint on user_id (one profile per user)
  - [ ] Run migration in local environment

- [ ] Implement calorie calculation logic (AC: 3)
  - [ ] Create `calculate_bmr(weight, height, age, sex)` function (Harris-Benedict)
  - [ ] Create `calculate_tdee(bmr, activity_level)` function (BMR × multiplier)
  - [ ] Activity levels: sedentary=1.2, moderate=1.5, active=1.7, very_active=1.9
  - [ ] Default to "moderate" (1.5) if not provided

- [ ] Implement macro split logic (AC: 4)
  - [ ] Create `get_macro_split(goal)` function
  - [ ] Return {"protein": 40, "carbs": 30, "fat": 30} for "build_muscle"
  - [ ] Return {"protein": 35, "carbs": 35, "fat": 30} for "lose_fat"
  - [ ] Return {"protein": 30, "carbs": 40, "fat": 30} for "general_health"

- [ ] Implement REST endpoints (AC: 2)
  - [ ] POST /eating-profiles: Create profile with derived values
  - [ ] GET /eating-profiles/{user_id}: Retrieve profile
  - [ ] PUT /eating-profiles/{user_id}: Update profile (recalculate derived values)
  - [ ] Add authentication check (validate JWT from Supabase)

- [ ] Add validation
  - [ ] Weight: 50-500 lbs or 20-200 kg
  - [ ] Height: 4'0"-7'0" or 120-220 cm
  - [ ] Eating preference: Must be one of predefined options
  - [ ] Return 400 Bad Request for invalid inputs

## Dev Notes

### Relevant Source Tree
- **Location:** `meals_service/app/models/eating_profile.py`
- **Routes:** `meals_service/app/routes/eating_profiles.py`
- **Migrations:** `meals_service/alembic/versions/`

### Key Technical Details
- meals_service database on port 5434 (separate from main DB)
- Harris-Benedict equation (men): BMR = 88.362 + (13.397 × weight_kg) + (4.799 × height_cm) - (5.677 × age)
- Harris-Benedict equation (women): BMR = 447.593 + (9.247 × weight_kg) + (3.098 × height_cm) - (4.330 × age)
- Default to "male" equation if sex not provided (simpler for MVP)

### Implementation Notes
```python
# Calorie calculation
def calculate_bmr(weight_kg: float, height_cm: float, age: int, sex: str = "male") -> int:
    """Calculate Basal Metabolic Rate using Harris-Benedict equation"""
    if sex == "male":
        bmr = 88.362 + (13.397 * weight_kg) + (4.799 * height_cm) - (5.677 * age)
    else:
        bmr = 447.593 + (9.247 * weight_kg) + (3.098 * height_cm) - (4.330 * age)
    return int(bmr)

def calculate_tdee(bmr: int, activity_level: str = "moderate") -> int:
    """Calculate Total Daily Energy Expenditure"""
    multipliers = {
        "sedentary": 1.2,
        "moderate": 1.5,
        "active": 1.7,
        "very_active": 1.9
    }
    return int(bmr * multipliers.get(activity_level, 1.5))

# Macro split logic
def get_macro_split(goal: str) -> dict:
    """Return macro split based on goal"""
    splits = {
        "build_muscle": {"protein": 40, "carbs": 30, "fat": 30},
        "lose_fat": {"protein": 35, "carbs": 35, "fat": 30},
        "general_health": {"protein": 30, "carbs": 40, "fat": 30}
    }
    return splits.get(goal, splits["general_health"])
```

### Testing
**Test file location:** `meals_service/tests/test_eating_profiles.py`

**Test standards:**
- Unit tests for calorie/macro calculation functions
- Integration test for REST endpoints (with test database)
- Validate calculations against known examples

**Testing frameworks:**
- pytest
- FastAPI TestClient for endpoint testing

**Specific testing requirements:**
- Test BMR calculation: 180 lbs, 5'10", age 30 → ~1,800 BMR
- Test TDEE calculation: BMR 1,800 × moderate (1.5) → 2,700 cal/day
- Test POST /eating-profiles creates profile with correct calorie_target
- Test validation rejects invalid weights (e.g., 1000 lbs)
- Test PUT updates recalculate derived values

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 7 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
