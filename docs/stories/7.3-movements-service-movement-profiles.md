# Story 7.3: movements_service Movement Profile Storage

## Status
Draft

## Story
**As a** backend engineer
**I want** movements_service to store training preferences and goals
**so that** workout programs can be filtered/recommended based on user profile

## Acceptance Criteria

1. New table `movement_profiles` with fields: id, user_id, training_preferences (JSONB), goals (JSONB), created_at, updated_at
2. REST endpoints: `POST /movement-profiles` (create), `GET /movement-profiles/{user_id}` (read), `PUT /movement-profiles/{user_id}` (update)
3. Training preferences stored as JSONB array: `["strength_training", "yoga"]`
4. Goals stored as JSONB array: `["build_muscle", "improve_flexibility"]`

## Tasks / Subtasks

- [ ] Create Alembic migration for `movement_profiles` table (AC: 1)
  - [ ] Add table with all required columns
  - [ ] Use JSONB type for training_preferences and goals
  - [ ] Add unique constraint on user_id (one profile per user)
  - [ ] Run migration in local environment

- [ ] Implement REST endpoints (AC: 2, 3, 4)
  - [ ] POST /movement-profiles: Create profile
  - [ ] GET /movement-profiles/{user_id}: Retrieve profile
  - [ ] PUT /movement-profiles/{user_id}: Update profile
  - [ ] Add authentication check (validate JWT from Supabase)

- [ ] Add validation
  - [ ] Training preferences: Must be from predefined list (strength_training, running, yoga, crossfit, sports, mixed)
  - [ ] Goals: Must be from predefined list (build_muscle, lose_fat, improve_endurance, rehab, general_health)
  - [ ] At least one training preference required
  - [ ] At least one goal required
  - [ ] Return 400 Bad Request for invalid inputs

- [ ] Add model/serializer
  - [ ] SQLAlchemy model for `movement_profiles` table
  - [ ] Pydantic schema for request/response validation
  - [ ] Handle JSONB serialization/deserialization

## Dev Notes

### Relevant Source Tree
- **Location:** `movements_service/app/models/movement_profile.py`
- **Routes:** `movements_service/app/routes/movement_profiles.py`
- **Migrations:** `movements_service/alembic/versions/`

### Key Technical Details
- movements_service database on port 5435 (separate from main DB)
- JSONB allows flexible storage for multi-select fields
- Future: Can add more fields (injuries, restrictions) without schema changes

### Implementation Notes
```python
# SQLAlchemy model
from sqlalchemy import Column, String, JSONB
from sqlalchemy.dialects.postgresql import UUID
import uuid

class MovementProfile(Base):
    __tablename__ = "movement_profiles"

    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    user_id = Column(UUID(as_uuid=True), unique=True, nullable=False)
    training_preferences = Column(JSONB, nullable=False)
    goals = Column(JSONB, nullable=False)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

# Pydantic schema
from pydantic import BaseModel, validator
from typing import List

class MovementProfileCreate(BaseModel):
    user_id: str
    training_preferences: List[str]
    goals: List[str]

    @validator("training_preferences")
    def validate_training_preferences(cls, v):
        valid_prefs = ["strength_training", "running", "yoga", "crossfit", "sports", "mixed"]
        if not all(pref in valid_prefs for pref in v):
            raise ValueError(f"Invalid training preference. Must be one of: {valid_prefs}")
        return v

    @validator("goals")
    def validate_goals(cls, v):
        valid_goals = ["build_muscle", "lose_fat", "improve_endurance", "rehab", "general_health"]
        if not all(goal in valid_goals for goal in v):
            raise ValueError(f"Invalid goal. Must be one of: {valid_goals}")
        return v
```

### Testing
**Test file location:** `movements_service/tests/test_movement_profiles.py`

**Test standards:**
- Unit tests for validation logic
- Integration test for REST endpoints (with test database)
- JSONB serialization/deserialization tests

**Testing frameworks:**
- pytest
- FastAPI TestClient for endpoint testing

**Specific testing requirements:**
- Test POST /movement-profiles creates profile with JSONB fields
- Test validation rejects invalid training preferences
- Test validation rejects empty arrays (at least one preference/goal required)
- Test GET retrieves JSONB fields correctly
- Test PUT updates JSONB fields

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-20 | v1.0 | Initial story creation from Epic 7 | Mary (Business Analyst) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
