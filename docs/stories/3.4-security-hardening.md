# Story 3.4: Security Hardening

## Status
Draft

## Story
**As a** security-conscious engineer
**I want** production secrets managed via Secret Manager with least-privilege IAM
**so that** API keys and DB credentials aren't exposed in environment variables or logs

## Acceptance Criteria

1. All secrets (OPENAI_API_KEY, DATABASE_URL, Supabase keys) stored in Google Secret Manager
2. Cloud Run services access secrets via volume mounts (not env vars)
3. Service accounts have minimal IAM roles (practices_service → only practices DB access)
4. Secrets rotated with version management (current + previous version available)
5. No secrets in Terraform state file (use data sources, not resources)
6. Audit: No secrets committed to git (scan .env files, code)

## Tasks / Subtasks

- [ ] Move secrets to Google Secret Manager (AC: 1)
  - [ ] Create secrets in Secret Manager: OPENAI_API_KEY, DATABASE_URL, SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE_KEY
  - [ ] Use `gcloud secrets create` or Terraform `google_secret_manager_secret` data source
  - [ ] Version secrets (add new version without deleting old)

- [ ] Configure Cloud Run to use Secret Manager (AC: 2)
  - [ ] Update Terraform: Use `secrets` block in Cloud Run v2 service config
  - [ ] Mount secrets as volume (not env vars) for better security
  - [ ] Test services can access secrets

- [ ] Implement least-privilege IAM (AC: 3)
  - [ ] Create service accounts for each service (practices_service, agent_service, etc.)
  - [ ] Grant minimal IAM roles: practices_service → Cloud SQL Client for practices DB only
  - [ ] Remove broad IAM roles (e.g., Editor, Owner)

- [ ] Set up secret rotation (AC: 4)
  - [ ] Enable secret versioning in Secret Manager
  - [ ] Document secret rotation process (how to add new version)
  - [ ] Test rollback to previous secret version

- [ ] Avoid secrets in Terraform state (AC: 5)
  - [ ] Use `google_secret_manager_secret` data source (not resource)
  - [ ] Reference secrets by name/version, don't create them in Terraform
  - [ ] Verify Terraform state file doesn't contain secret values

- [ ] Audit codebase for leaked secrets (AC: 6)
  - [ ] Scan .env files (ensure .gitignore includes .env*)
  - [ ] Use `git-secrets` or `truffleHog` to scan git history
  - [ ] Remove any committed secrets, rotate if found

## Dev Notes

### Relevant Source Tree
- **Terraform:** `infra/main.tf`, service-specific modules
- **Secrets:** Google Secret Manager (GCP Console or gcloud CLI)
- **Service Accounts:** IAM configuration in Terraform

### Key Technical Details
- Google Secret Manager stores secrets securely with versioning
- Cloud Run v2 supports mounting secrets as volumes (more secure than env vars)
- Least-privilege IAM: Each service account should only access what it needs
- Terraform data sources read existing resources without managing them
- Secret rotation: Keep previous version available for rollback

### Implementation Notes
- Secret Manager secret names: `production-openai-api-key`, `production-database-url`, etc.
- Cloud Run secret mount: `/secrets/openai-api-key` (read as file, not env var)
- Service accounts: `practices-service@project.iam.gserviceaccount.com`
- IAM roles: `roles/cloudsql.client` for database access, `roles/secretmanager.secretAccessor` for secrets

### SECURITY BEST PRACTICES
- **Never commit secrets to git** - use .gitignore for .env files
- **Rotate secrets regularly** - at least every 90 days
- **Use secret versions** - keep previous version for rollback
- **Least-privilege IAM** - grant minimum necessary permissions
- **Audit access** - enable Secret Manager audit logs

### Testing
**Test file location:** Manual security audit + Terraform validation

**Test standards:**
- Secrets accessible from Cloud Run services
- No secrets in Terraform state file
- No secrets in git history
- IAM roles correctly restricted

**Testing frameworks:**
- Manual gcloud CLI testing
- Terraform plan/apply validation
- git-secrets or truffleHog for secret scanning

**Specific testing requirements:**
- Test Cloud Run services can read secrets from volume mounts
- Test practices_service cannot access other services' databases (IAM enforcement)
- Scan Terraform state file: `grep -i "api_key\|password\|secret" terraform.tfstate` (should return nothing)
- Scan git history: `git-secrets --scan` or `trufflehog --regex --entropy=False .`
- Test secret rotation: Add new version, rollback to previous version

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | v1.0 | Initial story creation from Epic 3 | Sarah (PO Agent) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
